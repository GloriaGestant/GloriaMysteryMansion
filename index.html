<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Темный особняк - Путешествие Глории</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            image-rendering: pixelated;
            background-color: #111;
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            background-color: rgba(42, 26, 74, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 2;
        }
        
        #health-bar {
            width: 80px;
            height: 8px;
            background-color: #2a1a1a;
            margin-top: 5px;
            border: 1px solid #3d2a2a;
        }
        
        #health-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 100%;
            transition: width 0.3s;
        }
        
        #message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.9);
            padding: 10px 15px;
            border: 2px solid #b19cd9;
            max-width: 90%;
            text-align: center;
            display: none;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
            z-index: 2;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="black"/><path d="M30,20 L50,10 L70,20 L65,50 L75,70 L50,80 L25,70 L35,50 Z" fill="%232a1a4a"/><circle cx="40" cy="40" r="5" fill="%23b19cd9"/><circle cx="60" cy="40" r="5" fill="%23b19cd9"/></svg>');
            background-size: 150px;
            background-repeat: repeat;
        }
        
        #title {
            font-size: 28px;
            color: #b19cd9;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #b19cd9, 0 0 20px #b19cd9;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 0 10px;
        }
        
        #subtitle {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 30px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        #controls {
            margin-top: 20px;
            font-size: 12px;
            color: #777;
            text-align: center;
            max-width: 90%;
        }
        
        button {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 2px solid #b19cd9;
            padding: 10px 25px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        button:hover {
            background-color: #3d2a5f;
            text-shadow: 0 0 5px #b19cd9;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
        }
        
        #dialog-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.9);
            padding: 10px;
            border: 2px solid #b19cd9;
            max-width: 80%;
            text-align: center;
            display: none;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
            z-index: 5;
            line-height: 1.6;
            font-size: 16px;
            animation: pulse 2s infinite;
        }
        
        #dialog-text {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        #dialog-next {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 1px solid #b19cd9;
            padding: 5px 15px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 14px;
        }
        
        #inventory {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(42, 26, 74, 0.7);
            padding: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 2;
        }
        
        .inventory-item {
            width: 35px;
            height: 35px;
            background-color: rgba(58, 42, 90, 0.5);
            border: 1px solid #3d2a5f;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .inventory-item.active {
            border-color: #b19cd9;
            box-shadow: 0 0 5px #b19cd9;
        }
        
        .inventory-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated;
        }
        
        #fear-bar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 80px;
            height: 8px;
            background-color: #1a0a2a;
            margin-top: 5px;
            border: 1px solid #3d2a5f;
            z-index: 2;
        }
        
        #fear-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.3s;
        }
        
        #fear-label {
            position: absolute;
            bottom: 23px;
            left: 10px;
            font-size: 10px;
            color: #b19cd9;
            z-index: 2;
        }
        
        #telekenesis-bar {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 8px;
            background-color: #1a0a2a;
            margin-top: 5px;
            border: 1px solid #3d2a5f;
            z-index: 2;
        }
        
        #telekenesis-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.3s;
        }
        
        #telekenesis-label {
            position: absolute;
            bottom: 23px;
            right: 10px;
            font-size: 10px;
            color: #b19cd9;
            z-index: 2;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(177, 156, 217, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(177, 156, 217, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(177, 156, 217, 0.5); }
        }
        
        #flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }
        
        /* Мобильные элементы управления */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 1;
            opacity: 0.7;
            display: none;
        }
        
        #joystick {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(42, 26, 74, 0.5);
            border-radius: 50%;
            border: 2px solid #b19cd9;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }
        
        #joystick-knob {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(177, 156, 217, 0.7);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        #action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1;
            display: none;
        }
        
        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(42, 26, 74, 0.7);
            border: 2px solid #b19cd9;
            color: #b19cd9;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            text-align: center;
            touch-action: manipulation;
        }
        
        .action-btn:active {
            background-color: rgba(177, 156, 217, 0.3);
        }
        
        #restart-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(42, 26, 74, 0.7);
            border: 1px solid #b19cd9;
            color: #b19cd9;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 3;
            display: none;
            touch-action: manipulation;
        }

        /* Адаптивные стили для ПК */
        @media (min-width: 768px) {
            #game-container {
                width: 800px;
                height: 600px;
            }
            
            #ui {
                font-size: 16px;
            }
            
            #health-bar {
                width: 100px;
                height: 10px;
            }
            
            #message-box {
                font-size: 18px;
                padding: 15px 20px;
            }
            
            #title {
                font-size: 48px;
                margin-bottom: 20px;
                letter-spacing: 3px;
            }
            
            #subtitle {
                font-size: 18px;
                margin-bottom: 40px;
            }
            
            #controls {
                font-size: 14px;
                margin-top: 30px;
            }
            
            button {
                padding: 12px 30px;
                margin: 10px;
                font-size: 18px;
            }
            
            #dialog-box {
                padding: 15px;
            }
            
            #dialog-text {
                font-size: 16px;
            }
            
            #inventory {
                padding: 10px;
            }
            
            .inventory-item {
                width: 40px;
                height: 40px;
            }
            
            #fear-bar, #telekenesis-bar {
                width: 100px;
                height: 10px;
            }
            
            #fear-label, #telekenesis-label {
                font-size: 12px;
                bottom: 25px;
            }
        }

        /* Стили для мобильных устройств */
        @media (max-width: 767px) {
            #restart-btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        
        /* Новые элементы интерфейса */
        #room-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.7);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 2;
            display: none;
        }
        
        #ability-cooldowns {
            position: absolute;
            bottom: 50px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 2;
            display: none;
        }
        
        .cooldown-indicator {
            width: 80px;
            height: 8px;
            background-color: rgba(26, 10, 42, 0.7);
            border: 1px solid #3d2a5f;
            position: relative;
        }
        
        .cooldown-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.1s;
        }
        
        .cooldown-label {
            position: absolute;
            top: -15px;
            left: 0;
            font-size: 10px;
            color: #b19cd9;
        }
        
        #mini-map {
            position: absolute;
            top: 60px;
            right: 10px;
            width: 100px;
            height: 100px;
            background-color: rgba(26, 10, 42, 0.5);
            border: 1px solid #3d2a5f;
            z-index: 2;
            display: none;
        }
        
        #mini-map-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2px;
            padding: 2px;
        }
        
        .mini-map-room {
            background-color: rgba(58, 42, 90, 0.3);
            border: 1px solid #3d2a5f;
            position: relative;
        }
        
        .mini-map-room.active {
            background-color: rgba(177, 156, 217, 0.3);
            border-color: #b19cd9;
        }
        
        .mini-map-room.visited {
            background-color: rgba(100, 80, 140, 0.3);
        }
        
        .mini-map-room.artifact {
            position: relative;
        }
        
        .mini-map-room.artifact::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background-color: #b19cd9;
            border-radius: 50%;
        }
        
        .mini-map-room.artifact.collected::after {
            display: none;
        }
        
        #sound-toggle {
            position: absolute;
            bottom: 10px;
            right: 100px;
            width: 30px;
            height: 30px;
            background-color: rgba(42, 26, 74, 0.7);
            border: 1px solid #b19cd9;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            cursor: pointer;
        }

        /* Стили для финальной кат-сцены */
        #ending-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: #b19cd9;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        #ending-title {
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #b19cd9;
            animation: pulse 2s infinite;
        }
        
        #ending-text {
            font-size: 18px;
            line-height: 1.6;
            max-width: 800px;
            margin-bottom: 30px;
        }
        
        #ending-image {
            width: 300px;
            height: 300px;
            margin: 20px 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%232a1a4a" stroke="%23b19cd9" stroke-width="2"/><path d="M30,40 Q50,20 70,40 Q80,60 50,80 Q20,60 30,40 Z" fill="%23b19cd9"/><circle cx="40" cy="40" r="5" fill="%232a1a4a"/><circle cx="60" cy="40" r="5" fill="%232a1a4a"/><path d="M40,60 Q50,70 60,60" fill="none" stroke="%232a1a4a" stroke-width="2"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transform: scale(0.5);
            transition: all 2s ease-out;
        }
        
        #ending-image.show {
            opacity: 1;
            transform: scale(1);
        }
        
        #ending-button {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 2px solid #b19cd9;
            padding: 12px 30px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin-top: 30px;
            font-size: 18px;
            transition: all 0.3s;
            border-radius: 5px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease-out 3s;
        }
        
        #ending-button:hover {
            background-color: #3d2a5f;
            text-shadow: 0 0 5px #b19cd9;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
        }
        
        #ending-button.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @keyframes textReveal {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .ending-paragraph {
            opacity: 0;
            transform: translateY(20px);
            animation: textReveal 1s forwards;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui">
            <div>Артефакты: <span id="artifact-count">0</span>/7</div>
            <div>Здоровье:</div>
            <div id="health-bar"><div id="health-fill"></div></div>
        </div>
        
        <div id="room-indicator">Комната: Прихожая</div>
        
        <div id="fear-label">СТРАХ</div>
        <div id="fear-bar"><div id="fear-fill"></div></div>
        
        <div id="telekenesis-label">ТЕЛЕКИНЕЗ</div>
        <div id="telekenesis-bar"><div id="telekenesis-fill"></div></div>
        
        <div id="inventory">
            <div class="inventory-item" data-item="telekenesis">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='6' fill='%23b19cd9'/><path d='M4,8 L12,8 M8,4 L8,12' stroke='%232a1a4a' stroke-width='2'/></svg>" alt="Телекинез">
            </div>
            <div class="inventory-item" data-item="portal">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='7' fill='none' stroke='%23b19cd9' stroke-width='2'/><path d='M2,8 A6,6 0 0,1 14,8 A6,6 0 0,1 2,8' fill='%233d2a5f'/></svg>" alt="Портал">
            </div>
        </div>
        
        <div id="ability-cooldowns">
            <div class="cooldown-indicator">
                <div class="cooldown-label">ТЕЛЕКИНЕЗ</div>
                <div class="cooldown-fill" id="telekinesis-cooldown"></div>
            </div>
            <div class="cooldown-indicator">
                <div class="cooldown-label">ПОРТАЛ</div>
                <div class="cooldown-fill" id="portal-cooldown"></div>
            </div>
        </div>
        
        <div id="mini-map">
            <div id="mini-map-grid"></div>
        </div>
        
        <div id="message-box"></div>
        
        <div id="dialog-box">
            <div id="dialog-text"></div>
            <button id="dialog-next">Далее</button>
        </div>
        
        <div id="start-screen">
            <div id="title">ТАЙНА ГЛОРИИ</div>
            <div id="subtitle">После неудачного прыжка между мирами, Глория очнулась в странном особняке...<br>Ее кошачьи чувства сразу уловили что-то неладное - это место хранит секреты ее прошлого.<br>Найди 7 артефактов памяти, чтобы вспомнить путь домой.</div>
            <button id="start-button">НАЧАТЬ ИГРУ</button>
            <div id="controls" class="controls-info">Управление загружается...</div>
        </div>
        
        <!-- Мобильные элементы управления -->
        <div id="mobile-controls">
            <div id="joystick">
                <div id="joystick-knob"></div>
            </div>
        </div>
        
        <div id="action-buttons">
            <div class="action-btn" id="telekinesis-btn">ТЕЛЕКИНЕЗ</div>
            <div class="action-btn" id="portal-btn">ПОРТАЛ</div>
        </div>
        
        <button id="restart-btn">РЕСТАРТ (R)</button>
        
        <div id="sound-toggle">🔊</div>
        
        <div id="flash"></div>

        <!-- Финальная кат-сцена -->
        <div id="ending-screen">
            <div id="ending-title">КОНЕЦ ИСТОРИИ</div>
            <div id="ending-text">
                <div class="ending-paragraph" style="animation-delay: 0.5s">Глория расставляет артефакты по кругу в центре прихожей. Каждый начинает светиться мягким фиолетовым светом.</div>
                <div class="ending-paragraph" style="animation-delay: 1s">Внезапно свет усиливается, и стены особняка начинают растворяться, обнажая воспоминания...</div>
                <div class="ending-paragraph" style="animation-delay: 1.5s">Лаборатория. Клетки. Боль. Но также - побег, сопротивление, первое использование своих сил.</div>
                <div class="ending-paragraph" style="animation-delay: 2s">Голос из прошлого: "Глория, ты была лучшим из наших экспериментов. Единственная, кто выжил..."</div>
                <div class="ending-paragraph" style="animation-delay: 2.5s">Тени вокруг содрогаются, цепляясь за Глорию, но свет артефактов становится ярче.</div>
                <div id="ending-image"></div>
                <div class="ending-paragraph" style="animation-delay: 3s">Вспышка! Глория чувствует, как реальность вокруг меняется. Она видит дорогу домой - тусклый свет в конце туннеля.</div>
                <div class="ending-paragraph" style="animation-delay: 3.5s">Последнее, что она слышит - голос особняка: "Ты вернешься... Они все возвращаются..."</div>
                <div class="ending-paragraph" style="animation-delay: 4s">НОВАЯ ГЛАВА</div>
                <div class="ending-paragraph" style="animation-delay: 4.5s">Глория открывает глаза. Она лежит на мягком ковре в знакомой комнате. За окном - привычный городской пейзаж.</div>
                <div class="ending-paragraph" style="animation-delay: 5s">Но в зеркале она замечает что-то странное - ее глаза иногда мерцают тем же фиолетовым светом, что и артефакты...</div>
            </div>
            <button id="ending-button">ИГРАТЬ СНОВА</button>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-dark-ambient-tribal-1231.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="artifactSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="hurtSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-jumping-in-a-video-game-2043.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="enemySound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-creature-cry-of-hurt-2208.mp3" type="audio/mpeg">
    </audio>

    <audio id="victorySound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="portalSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-spell-669.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="telekinesisSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-quick-jump-arcade-game-239.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Игровые переменные для Глории
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const artifactCountElement = document.getElementById('artifact-count');
        const healthFillElement = document.getElementById('health-fill');
        const fearFillElement = document.getElementById('fear-fill');
        const telekenesisFillElement = document.getElementById('telekenesis-fill');
        const messageBox = document.getElementById('message-box');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const dialogBox = document.getElementById('dialog-box');
        const dialogText = document.getElementById('dialog-text');
        const dialogNext = document.getElementById('dialog-next');
        const inventoryItems = document.querySelectorAll('.inventory-item');
        const flash = document.getElementById('flash');
        const restartBtn = document.getElementById('restart-btn');
        const controlsInfo = document.querySelector('.controls-info');
        const roomIndicator = document.getElementById('room-indicator');
        const miniMap = document.getElementById('mini-map');
        const miniMapGrid = document.getElementById('mini-map-grid');
        const soundToggle = document.getElementById('sound-toggle');
        
        // Мобильные элементы управления
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystick-knob');
        const telekinesisBtn = document.getElementById('telekinesis-btn');
        const portalBtn = document.getElementById('portal-btn');
        const mobileControls = document.getElementById('mobile-controls');
        const actionButtons = document.getElementById('action-buttons');
        const abilityCooldowns = document.getElementById('ability-cooldowns');
        const telekinesisCooldown = document.getElementById('telekinesis-cooldown');
        const portalCooldown = document.getElementById('portal-cooldown');
        
        // Установка размеров canvas
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // Звуки
        const bgMusic = document.getElementById('bgMusic');
        const artifactSound = document.getElementById('artifactSound');
        const hurtSound = document.getElementById('hurtSound');
        const enemySound = document.getElementById('enemySound');
        const victorySound = document.getElementById('victorySound');
        const portalSound = document.getElementById('portalSound');
        const telekinesisSound = document.getElementById('telekinesisSound');
        
        let soundEnabled = true;
        let gameRunning = false;
        let player = {
            x: 400,
            y: 300,
            size: 20,
            speed: 3,
            health: 100,
            fear: 0,
            maxFear: 100,
            artifacts: 0,
            telekinesis: 0,
            maxTelekinesis: 100,
            telekinesisCooldown: 5000,
            lastTelekinesisUse: 0,
            portalCharges: 3,
            maxPortalCharges: 3,
            portalCooldown: 15000,
            lastPortalUse: 0,
            dogEnemiesNearby: 0,
            visitedRooms: new Set()
        };
        
        let artifacts = [];
        let enemies = [];
        let lastEnemySpawn = 0;
        let gameTime = 0;
        let messageTimeout;
        let dialog = [];
        let currentDialog = 0;
        let rooms = [];
        let currentRoom = 0;
        let darknessAlpha = 0.7;
        let lastFearIncrease = 0;
        let lastTelekinesisIncrease = 0;
        let cooldownInterval;
        
        // Определение типа устройства
        let isMobile = false;
        
        // Управление клавиатурой (для ПК)
        let keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            KeyT: false,
            KeyP: false,
            KeyM: false
        };
        
        // Джойстик переменные (для мобильных)
        let joystickActive = false;
        let joystickCenterX = 0;
        let joystickCenterY = 0;
        let joystickX = 0;
        let joystickY = 0;
        let joystickAngle = 0;
        let joystickDistance = 0;
        
        // История и диалоги
        const story = [
            "После неудачного прыжка между мирами, Глория очнулась в странном особняке...",
            "Ее кошачьи чувства сразу уловили что-то неладное - это место хранит секреты ее прошлого.",
            "Голос в голове прошептал: 'Найди 7 артефактов своей памяти, чтобы вспомнить путь домой...'",
            "Но особняк не хочет отпускать свою добычу. Тени шепчутся о прошлых жертвах.",
            "Используй свои способности: телекинез и порталы, но будь осторожна - они ограничены.",
            "Твоя кошачья природа дает тебе преимущества, но и делает уязвимой к определенным опасностям..."
        ];
        
        const roomNames = [
            "Прихожая", "Гостиная", "Библиотека", "Столовая",
            "Кухня", "Кабинет", "Детская", "Чердак"
        ];
        
        const roomDescriptions = [
            "Стены украшены портретами кошек с пустыми глазницами. Глория чувствует, как ее хвост непроизвольно вздыбливается.",
            "Развалившееся кресло-качалка все еще движется. На полу - следы когтей, слишком большие для обычной кошки...",
            "Книги с названиями 'История экспериментов' и 'Гибриды человека и животного'. Глорию бросает в дрожь.",
            "На столе - семь тарелок с чем-то, что когда-то было едой. На одной - ошейник с именем 'Мояо'...",
            "Запах гниющего мяса смешивается с ароматом валерьянки. Ножи висят на стене в идеальном порядке.",
            "Стены испещрены чертежами неких существ. На столе - шприцы с неизвестной жидкостью. Глория чувствует, как учащается ее пульс.",
            "Игрушечные собаки с горящими красными глазами. Колыбель качается, хотя в комнате нет ни малейшего ветерка...",
            "Здесь темнее всего. В углу - клетка с царапинами изнутри. Глория слышит тихое мяуканье, но источник звука найти не может."
        ];
        
        const enemyTypes = [
            { 
                name: "Тень экспериментатора", 
                type: "humanoid", 
                speed: 1.2, 
                size: 20, 
                color: '#3a1a4a', 
                fear: 5,
                trigger: "Приближается, шепча что-то о 'процедурах' и 'улучшениях'",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-creature-cry-of-hurt-2208.mp3"
            },
            { 
                name: "Пес тьмы", 
                type: "dog", 
                speed: 1.8, 
                size: 24, 
                color: '#5a1a1a', 
                fear: 15,
                trigger: "Рычит и скалится, напоминая Глории о ее страхе перед собаками",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-angry-dog-barking-35.mp3"
            },
            { 
                name: "Шприцевая тень", 
                type: "syringe", 
                speed: 1.3, 
                size: 16, 
                color: '#1a4a3a', 
                fear: 20,
                trigger: "Держит в руках огромный шприц, капающий странной жидкостью",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-horror-needle-2669.mp3"
            }
        ];
        
        // Генерация комнат
        function generateRooms() {
            rooms = [];
            for (let i = 0; i < 8; i++) {
                rooms.push({
                    name: roomNames[i],
                    width: canvas.width,
                    height: canvas.height,
                    description: roomDescriptions[i],
                    artifacts: [],
                    enemies: []
                });
            }
            
            // Распределяем 7 артефактов по комнатам
            let artifactsToPlace = 7;
            for (let i = 0; i < rooms.length && artifactsToPlace > 0; i++) {
                const artifactsInRoom = Math.min(Math.floor(Math.random() * 2) + 1, artifactsToPlace);
                for (let j = 0; j < artifactsInRoom; j++) {
                    rooms[i].artifacts.push({
                        x: Math.floor(Math.random() * (rooms[i].width - 40)) + 20,
                        y: Math.floor(Math.random() * (rooms[i].height - 40)) + 20,
                        collected: false
                    });
                }
                artifactsToPlace -= artifactsInRoom;
            }
            
            currentRoom = 0;
            player.visitedRooms.add(currentRoom);
            artifacts = rooms[currentRoom].artifacts;
            enemies = rooms[currentRoom].enemies;
            updateRoomIndicator();
            updateMiniMap();
            showMessage(rooms[currentRoom].description);
        }
        
        // Обновление индикатора комнаты
        function updateRoomIndicator() {
            roomIndicator.textContent = `Комната: ${rooms[currentRoom].name}`;
            roomIndicator.style.display = 'block';
        }
        
        // Обновление мини-карты
        function updateMiniMap() {
            miniMapGrid.innerHTML = '';
            
            for (let i = 0; i < rooms.length; i++) {
                const roomElement = document.createElement('div');
                roomElement.className = 'mini-map-room';
                
                if (i === currentRoom) {
                    roomElement.classList.add('active');
                } else if (player.visitedRooms.has(i)) {
                    roomElement.classList.add('visited');
                }
                
                // Проверяем, есть ли в комнате не собранные артефакты
                const hasArtifacts = rooms[i].artifacts.some(a => !a.collected);
                if (hasArtifacts) {
                    roomElement.classList.add('artifact');
                }
                
                // Если артефакты собраны, добавляем класс collected
                if (rooms[i].artifacts.every(a => a.collected)) {
                    roomElement.classList.add('collected');
                }
                
                miniMapGrid.appendChild(roomElement);
            }
            
            miniMap.style.display = 'block';
        }
        
        // Смена комнаты
        function changeRoom(direction) {
            if (!gameRunning) return;
            
            // Проверяем границы
            if (direction === 'left' && player.x <= player.size) {
                if (currentRoom > 0) {
                    currentRoom--;
                    player.x = canvas.width - player.size - 1;
                } else {
                    player.x = player.size;
                    return;
                }
            } else if (direction === 'right' && player.x >= canvas.width - player.size) {
                if (currentRoom < rooms.length - 1) {
                    currentRoom++;
                    player.x = player.size + 1;
                } else {
                    player.x = canvas.width - player.size;
                    return;
                }
            } else if (direction === 'up' && player.y <= player.size) {
                if (currentRoom > 3) {
                    currentRoom -= 4;
                    player.y = canvas.height - player.size - 1;
                } else {
                    player.y = player.size;
                    return;
                }
            } else if (direction === 'down' && player.y >= canvas.height - player.size) {
                if (currentRoom < 4) {
                    currentRoom += 4;
                    player.y = player.size + 1;
                } else {
                    player.y = canvas.height - player.size;
                    return;
                }
            } else {
                return;
            }
            
            // Добавляем комнату в посещенные
            player.visitedRooms.add(currentRoom);
            
            // Обновляем данные комнаты
            artifacts = rooms[currentRoom].artifacts;
            enemies = rooms[currentRoom].enemies;
            
            // Увеличиваем страх при переходе в новую комнату
            player.fear += 10;
            if (player.fear > player.maxFear) player.fear = player.maxFear;
            updateFearBar();
            
            // Обновляем индикаторы
            updateRoomIndicator();
            updateMiniMap();
            
            // Показываем описание комнаты
            showMessage(rooms[currentRoom].description);
            
            // Спавн врагов в новой комнате (с вероятностью 50%)
            if (enemies.length === 0 && Math.random() > 0.5) {
                spawnEnemy();
            }
        }
        
        // Генерация врагов
        function spawnEnemy() {
            if (enemies.length >= 3 + Math.floor(gameTime / 1500)) return;
            
            let side = Math.floor(Math.random() * 4);
            let x, y;
            
            if (side === 0) {
                x = Math.random() * canvas.width;
                y = -20;
            } else if (side === 1) {
                x = canvas.width + 20;
                y = Math.random() * canvas.height;
            } else if (side === 2) {
                x = Math.random() * canvas.width;
                y = canvas.height + 20;
            } else {
                x = -20;
                y = Math.random() * canvas.height;
            }
            
            const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            enemies.push({
                x: x,
                y: y,
                size: type.size,
                speed: type.speed,
                color: type.color,
                fear: type.fear,
                type: type.type,
                angle: Math.atan2(player.y - y, player.x - x),
                active: true,
                flashTimer: 0,
                sound: type.sound
            });
            
            if (soundEnabled) {
                enemySound.src = type.sound;
                enemySound.currentTime = 0;
                enemySound.play().catch(e => console.log("Audio play failed:", e));
            }
        }
        
        // Показать сообщение
        function showMessage(text, duration = 3000) {
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }
        
        // Показать диалог
        function showDialog(texts) {
            dialog = texts;
            currentDialog = 0;
            dialogText.textContent = dialog[currentDialog];
            dialogBox.style.display = 'block';
            gameRunning = false;
        }
        
        // Следующая реплика диалога
        function nextDialog() {
            currentDialog++;
            if (currentDialog < dialog.length) {
                dialogText.textContent = dialog[currentDialog];
            } else {
                dialogBox.style.display = 'none';
                gameRunning = true;
                update();
            }
        }
        
        // Проверка столкновений
        function checkCollision(x1, y1, size1, x2, y2, size2) {
            return (
                x1 < x2 + size2 &&
                x1 + size1 > x2 &&
                y1 < y2 + size2 &&
                y1 + size1 > y2
            );
        }
        
        // Обновление шкалы страха
        function updateFearBar() {
            fearFillElement.style.width = player.fear + '%';
            
            if (player.fear < 30) {
                fearFillElement.style.backgroundColor = '#b19cd9';
            } else if (player.fear < 70) {
                fearFillElement.style.backgroundColor = '#a18cd9';
            } else {
                fearFillElement.style.backgroundColor = '#917cd9';
            }
        }
        
        // Обновление шкалы телекинеза
        function updateTelekinesisBar() {
            telekenesisFillElement.style.width = player.telekinesis + '%';
        }
        
        // Обновление индикаторов перезарядки
        function updateCooldownIndicators() {
            const now = Date.now();
            
            // Телекинез
            const telekinesisTimeLeft = player.telekinesisCooldown - (now - player.lastTelekinesisUse);
            const telekinesisPercent = Math.max(0, Math.min(100, 100 - (telekinesisTimeLeft / player.telekinesisCooldown * 100)));
            telekinesisCooldown.style.width = telekinesisPercent + '%';
            
            // Портал
            const portalTimeLeft = player.portalCooldown - (now - player.lastPortalUse);
            const portalPercent = Math.max(0, Math.min(100, 100 - (portalTimeLeft / player.portalCooldown * 100)));
            portalCooldown.style.width = portalPercent + '%';
        }
        
        // Использование телекинеза
        function useTelekinesis() {
            const now = Date.now();
            if (player.telekinesis < 30 || now - player.lastTelekinesisUse < player.telekinesisCooldown) return;
            
            player.lastTelekinesisUse = now;
            
            // Отталкиваем врагов
            enemies.forEach(enemy => {
                if (enemy.active) {
                    const angle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
                    enemy.x += Math.cos(angle) * 50;
                    enemy.y += Math.sin(angle) * 50;
                    enemy.speed *= 0.5;
                    
                    // Особый эффект на врагов-собак
                    if (enemy.type === "dog") {
                        enemy.speed *= 0.3;
                        player.fear -= 10;
                        if (player.fear < 0) player.fear = 0;
                    }
                }
            });
            
            player.telekinesis = 0;
            updateTelekinesisBar();
            
            showMessage("Телекинез! Тени отшвырнуты прочь!", 1500);
            
            if (soundEnabled) {
                telekinesisSound.currentTime = 0;
                telekinesisSound.play().catch(e => console.log("Audio play failed:", e));
            }
            
            flash.style.backgroundColor = "#b19cd9";
            flash.style.opacity = 0.3;
            setTimeout(() => {
                flash.style.opacity = 0;
            }, 300);
        }
        
        // Использование портала
        function usePortal() {
            const now = Date.now();
            if (player.portalCharges <= 0 || now - player.lastPortalUse < player.portalCooldown) return;
            
            player.lastPortalUse = now;
            player.portalCharges--;
            
            let safeSpot = false;
            let attempts = 0;
            
            while (!safeSpot && attempts < 10) {
                player.x = Math.floor(Math.random() * (canvas.width - 100)) + 50;
                player.y = Math.floor(Math.random() * (canvas.height - 100)) + 50;
                
                safeSpot = true;
                for (const enemy of enemies) {
                    const dist = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                    if (dist < 150) {
                        safeSpot = false;
                        break;
                    }
                }
                attempts++;
            }
            
            updateInventory();
            
            showMessage("Портал открыт! Глория перемещается в безопасное место.", 1500);
            
            if (soundEnabled) {
                portalSound.currentTime = 0;
                portalSound.play().catch(e => console.log("Audio play failed:", e));
            }
            
            flash.style.backgroundColor = "#3d2a5f";
            flash.style.opacity = 0.5;
            setTimeout(() => {
                flash.style.opacity = 0;
            }, 500);
        }
        
        // Обновление инвентаря
        function updateInventory() {
            inventoryItems.forEach(item => {
                item.classList.remove('active');
                
                if (item.dataset.item === 'telekenesis') {
                    const now = Date.now();
                    if (player.telekinesis >= 30 && now - player.lastTelekinesisUse > player.telekinesisCooldown) {
                        item.classList.add('active');
                    }
                }
                
                if (item.dataset.item === 'portal') {
                    if (player.portalCharges > 0 && Date.now() - player.lastPortalUse > player.portalCooldown) {
                        item.classList.add('active');
                    }
                }
            });
        }
        
        // Обновление игры
        function update() {
            if (!gameRunning) return;
            
            gameTime++;
            
            // Управление игроком
            if (isMobile) {
                // Мобильное управление через джойстик
                if (joystickActive) {
                    const speedFactor = joystickDistance / 30;
                    player.x += Math.cos(joystickAngle) * player.speed * speedFactor;
                    player.y += Math.sin(joystickAngle) * player.speed * speedFactor;
                    
                    // Проверка смены комнаты
                    if (player.x <= player.size) {
                        changeRoom('left');
                    } else if (player.x >= canvas.width - player.size) {
                        changeRoom('right');
                    }
                    
                    if (player.y <= player.size) {
                        changeRoom('up');
                    } else if (player.y >= canvas.height - player.size) {
                        changeRoom('down');
                    }
                }
            } else {
                // Управление с клавиатуры
                if (keys.ArrowUp) {
                    player.y -= player.speed;
                    changeRoom('up');
                }
                if (keys.ArrowDown) {
                    player.y += player.speed;
                    changeRoom('down');
                }
                if (keys.ArrowLeft) {
                    player.x -= player.speed;
                    changeRoom('left');
                }
                if (keys.ArrowRight) {
                    player.x += player.speed;
                    changeRoom('right');
                }
                
                // Использование телекинеза (T)
                if (keys.KeyT && player.telekinesis >= 30 && Date.now() - player.lastTelekinesisUse > player.telekinesisCooldown) {
                    useTelekinesis();
                    keys.KeyT = false;
                }
                
                // Использование портала (P)
                if (keys.KeyP && player.portalCharges > 0 && Date.now() - player.lastPortalUse > player.portalCooldown) {
                    usePortal();
                    keys.KeyP = false;
                }
                
                // Переключение мини-карты (M)
                if (keys.KeyM) {
                    miniMap.style.display = miniMap.style.display === 'none' ? 'block' : 'none';
                    keys.KeyM = false;
                }
            }
            
            // Границы игрока
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            
            // Восстановление телекинеза
            const now = Date.now();
            if (now - lastTelekinesisIncrease > 1000 && player.telekinesis < player.maxTelekinesis) {
                player.telekinesis += 1;
                lastTelekinesisIncrease = now;
                updateTelekinesisBar();
                updateInventory();
            }
            
            // Восстановление зарядов портала
            if (player.portalCharges < player.maxPortalCharges && now - player.lastPortalUse > player.portalCooldown) {
                player.portalCharges = player.maxPortalCharges;
                updateInventory();
                showMessage("Порталы перезаряжены!", 2000);
            }
            
            // Кошачьи подсказки
            if (Math.random() < 0.005 && player.fear < 50) {
                const hints = [
                    "Где-то вдалеке слышится мяуканье... Может, это подсказка?",
                    "Кошачьи уши улавливают шепот: 'Ищи там, где темнее всего...'",
                    "Нос учуял слабый запах валерьянки, исходящий от одной из стен...",
                    "Воспоминание: 'Артефакты светятся фиолетовым... ищи свет в темноте'",
                    "Инстинкты подсказывают: опасность рядом, когда хвост вздыбливается"
                ];
                showMessage(hints[Math.floor(Math.random() * hints.length)]);
            }
            
            // Обновление страха
            if (now - lastFearIncrease > 3000) {
                let fearIncrease = 1;
                
                fearIncrease += Math.floor(player.fear / 30);
                
                player.dogEnemiesNearby = 0;
                
                enemies.forEach(enemy => {
                    if (enemy.active) {
                        const dist = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                        
                        if (dist < 200) {
                            if (enemy.type === "dog") {
                                fearIncrease += 3;
                                player.dogEnemiesNearby++;
                            } else if (enemy.type === "syringe") {
                                fearIncrease += 4;
                            } else {
                                fearIncrease += 1;
                            }
                        }
                    }
                });
                
                player.fear += fearIncrease;
                lastFearIncrease = now;
                
                if (player.fear > player.maxFear) {
                    player.fear = player.maxFear;
                    
                    player.health -= 0.5;
                    healthFillElement.style.width = player.health + '%';
                    
                    if (player.health <= 0) {
                        showMessage("ПАНИЧЕСКАЯ АТАКА! Глория теряет сознание... Нажмите кнопку рестарта", 5000);
                        gameRunning = false;
                        restartBtn.style.display = 'block';
                    }
                }
                
                updateFearBar();
            }
            
            // Эффекты страха
            if (player.fear > 70) {
                darknessAlpha = 0.8 - (player.fear / 250);
                
                if (Math.random() < 0.02) {
                    ctx.fillStyle = `rgba(177, 156, 217, ${Math.random() * 0.1})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                darknessAlpha = 0.7;
            }
            
            // Сбор артефактов
            artifacts.forEach(artifact => {
                if (!artifact.collected && checkCollision(
                    player.x - player.size/2, player.y - player.size/2, player.size,
                    artifact.x - 8, artifact.y - 8, 16
                )) {
                    artifact.collected = true;
                    player.artifacts++;
                    artifactCountElement.textContent = player.artifacts;
                    
                    if (soundEnabled) {
                        artifactSound.currentTime = 0;
                        artifactSound.play().catch(e => console.log("Audio play failed:", e));
                    }
                    
                    showMessage('Артефакт памяти найден! ' + player.artifacts + '/7', 2000);
                    
                    player.fear = Math.max(0, player.fear - 15);
                    updateFearBar();
                    
                    // Обновляем мини-карту
                    updateMiniMap();
                    
                    if (player.artifacts === 7) {
                        showMessage('Вы собрали все артефакты! Вернитесь в прихожую, чтобы восстановить память.', 5000);
                    }
                }
            });
            
            // Проверка победы
            if (player.artifacts === 7 && currentRoom === 0 && 
                checkCollision(player.x, player.y, player.size, 50, 50, 100)) {
                // Останавливаем игру
                gameRunning = false;
                
                // Останавливаем музыку и проигрываем финальный звук
                bgMusic.pause();
                if (soundEnabled) {
                    victorySound.volume = 0.5;
                    victorySound.play().catch(e => console.log(e));
                }
                
                // Показываем финальную кат-сцену
                showEndingScene();
            }
            
            // Спавн врагов
            if (gameTime - lastEnemySpawn > 300 && enemies.length < 3 + Math.floor(gameTime / 1500)) {
                spawnEnemy();
                lastEnemySpawn = gameTime;
            }
            
            // Движение врагов
            enemies.forEach(enemy => {
                if (enemy.active) {
                    enemy.x += Math.cos(enemy.angle) * enemy.speed;
                    enemy.y += Math.sin(enemy.angle) * enemy.speed;
                    
                    const distToPlayer = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                    if (distToPlayer < 300) {
                        enemy.angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    }
                    
                    // Проверка столкновения с игроком
                    if (checkCollision(
                        player.x - player.size/2, player.y - player.size/2, player.size,
                        enemy.x - enemy.size/2, enemy.y - enemy.size/2, enemy.size
                    )) {
                        player.health -= 5;
                        healthFillElement.style.width = player.health + '%';
                        
                        if (soundEnabled) {
                            hurtSound.currentTime = 0;
                            hurtSound.play().catch(e => console.log("Audio play failed:", e));
                        }
                        
                        player.fear += enemy.fear;
                        updateFearBar();
                        
                        if (player.health <= 0) {
                            showMessage("ВЫ ПОГИБЛИ... НАЖМИТЕ КНОПКУ РЕСТАРТА", 5000);
                            gameRunning = false;
                            restartBtn.style.display = 'block';
                        }
                    }
                }
            });
            
            // Обновляем индикаторы перезарядки
            updateCooldownIndicators();
            
            // Отрисовка
            draw();
            
            requestAnimationFrame(update);
        }
        
        // Отрисовка игры
        function draw() {
            // Очистка экрана
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Отрисовка комнаты
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(50, 50, canvas.width - 100, canvas.height - 100);
            
            ctx.strokeStyle = '#3a2a5a';
            ctx.lineWidth = 3;
            ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
            
            // Отрисовка дверей
            ctx.fillStyle = '#2a1a3a';
            if (currentRoom > 0) {
                ctx.fillRect(40, canvas.height/2 - 30, 10, 60);
            }
            if (currentRoom < rooms.length - 1) {
                ctx.fillRect(canvas.width - 50, canvas.height/2 - 30, 10, 60);
            }
            if (currentRoom > 3) {
                ctx.fillRect(canvas.width/2 - 30, 40, 60, 10);
            }
            if (currentRoom < 4) {
                ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 10);
            }
            
            // Отрисовка артефактов
            artifacts.forEach(artifact => {
                if (!artifact.collected) {
                    // Основа
                    ctx.fillStyle = '#3d2a5f';
                    ctx.beginPath();
                    ctx.arc(artifact.x, artifact.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Символ
                    ctx.strokeStyle = '#b19cd9';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(artifact.x - 5, artifact.y);
                    ctx.lineTo(artifact.x + 5, artifact.y);
                    ctx.moveTo(artifact.x, artifact.y - 5);
                    ctx.lineTo(artifact.x, artifact.y + 5);
                    ctx.stroke();
                    
                    // Свечение
                    let gradient = ctx.createRadialGradient(
                        artifact.x, artifact.y, 0,
                        artifact.x, artifact.y, 40
                    );
                    gradient.addColorStop(0, 'rgba(177, 156, 217, 0.6)');
                    gradient.addColorStop(1, 'rgba(177, 156, 217, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(artifact.x, artifact.y, 40, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Отрисовка врагов
            enemies.forEach(enemy => {
                if (enemy.active) {
                    // Тень
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y + 5, enemy.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Тело
                    ctx.fillStyle = enemy.color;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Особые детали для разных типов
                    if (enemy.type === "humanoid") {
                        // Глазы
                        ctx.fillStyle = '#f00';
                        ctx.beginPath();
                        ctx.arc(enemy.x - 4, enemy.y - 2, 2, 0, Math.PI * 2);
                        ctx.arc(enemy.x + 4, enemy.y - 2, 2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Руки
                        ctx.strokeStyle = enemy.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(enemy.x - 6, enemy.y + 5);
                        ctx.lineTo(enemy.x - 12, enemy.y + 15);
                        ctx.moveTo(enemy.x + 6, enemy.y + 5);
                        ctx.lineTo(enemy.x + 12, enemy.y + 15);
                        ctx.stroke();
                    } else if (enemy.type === "dog") {
                        // Уши
                        ctx.fillStyle = enemy.color;
                        ctx.beginPath();
                        ctx.moveTo(enemy.x - 6, enemy.y - 8);
                        ctx.lineTo(enemy.x - 10, enemy.y - 15);
                        ctx.lineTo(enemy.x - 2, enemy.y - 10);
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(enemy.x + 6, enemy.y - 8);
                        ctx.lineTo(enemy.x + 10, enemy.y - 15);
                        ctx.lineTo(enemy.x + 2, enemy.y - 10);
                        ctx.fill();
                        
                        // Пасть
                        ctx.fillStyle = '#f00';
                        ctx.beginPath();
                        ctx.arc(enemy.x, enemy.y + 3, 4, 0, Math.PI);
                        ctx.fill();
                    } else if (enemy.type === "syringe") {
                        // Шприц
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(enemy.x - 2, enemy.y - 10, 4, 15);
                        
                        // Игла
                        ctx.fillStyle = '#aaa';
                        ctx.fillRect(enemy.x - 1, enemy.y - 15, 2, 5);
                        
                        // Жидкость
                        ctx.fillStyle = '#1a4';
                        ctx.fillRect(enemy.x - 2, enemy.y - 8, 4, 5);
                    }
                }
            });
            
            // Отрисовка Глории
            drawPlayer();
            
            // Затемнение
            ctx.fillStyle = `rgba(0, 0, 0, ${darknessAlpha})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Отрисовка игрока (Глории)
        function drawPlayer() {
            // Тень
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.arc(player.x, player.y + 5, player.size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Тело (меняется от страха)
            const baseColor = player.fear < 50 ? '#3a2a5a' : 
                            player.fear < 80 ? '#4a3a6a' : '#5a4a7a';
            
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Уши
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.moveTo(player.x - 8, player.y - 10);
            ctx.lineTo(player.x - 12, player.y - 20);
            ctx.lineTo(player.x - 4, player.y - 12);
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(player.x + 8, player.y - 10);
            ctx.lineTo(player.x + 12, player.y - 20);
            ctx.lineTo(player.x + 4, player.y - 12);
            ctx.fill();
            
            // Глазы
            const eyeColor = player.fear < 50 ? '#a1c9a7' : 
                            player.fear < 80 ? '#d1a9a9' : '#f99';
            
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            
            // Зрачки
            const pupilSize = player.fear < 50 ? 3 : 
                            player.fear < 80 ? 2 : 1;
            
            // Левый глаз
            ctx.arc(player.x - 5, player.y - 2, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#2a1a4a';
            ctx.beginPath();
            ctx.arc(player.x - 5, player.y - 2, pupilSize, 0, Math.PI * 2);
            ctx.fill();
            
            // Правый глаз
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(player.x + 5, player.y - 2, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#2a1a4a';
            ctx.beginPath();
            ctx.arc(player.x + 5, player.y - 2, pupilSize, 0, Math.PI * 2);
            ctx.fill();
            
            // Усы (если не слишком напугана)
            if (player.fear < 70) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                // Левые усы
                ctx.beginPath();
                ctx.moveTo(player.x - 8, player.y + 2);
                ctx.lineTo(player.x - 18, player.y);
                ctx.moveTo(player.x - 8, player.y + 3);
                ctx.lineTo(player.x - 18, player.y + 3);
                ctx.moveTo(player.x - 8, player.y + 4);
                ctx.lineTo(player.x - 18, player.y + 6);
                ctx.stroke();
                
                // Правые усы
                ctx.beginPath();
                ctx.moveTo(player.x + 8, player.y + 2);
                ctx.lineTo(player.x + 18, player.y);
                ctx.moveTo(player.x + 8, player.y + 3);
                ctx.lineTo(player.x + 18, player.y + 3);
                ctx.moveTo(player.x + 8, player.y + 4);
                ctx.lineTo(player.x + 18, player.y + 6);
                ctx.stroke();
            }
            
            // Хвост (анимированный)
            ctx.strokeStyle = baseColor;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(player.x, player.y + 10);
            
            const tailCurve = Math.sin(gameTime * 0.1) * (player.fear < 50 ? 5 : 10);
            ctx.quadraticCurveTo(
                player.x + tailCurve, 
                player.y + 20, 
                player.x + (tailCurve * 0.5), 
                player.y + 30
            );
            ctx.stroke();
        }
        
        // Управление джойстиком (для мобильных)
        function setupJoystick() {
            const joystickRect = joystick.getBoundingClientRect();
            joystickCenterX = joystickRect.left + joystickRect.width / 2;
            joystickCenterY = joystickRect.top + joystickRect.height / 2;
            
            joystick.addEventListener('touchstart', handleJoystickStart);
            joystick.addEventListener('touchmove', handleJoystickMove);
            joystick.addEventListener('touchend', handleJoystickEnd);
            
            // Для тестирования на ПК
            joystick.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
        }
        
        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
            updateJoystickPosition(e);
        }
        
        function handleJoystickMove(e) {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystickPosition(e);
        }
        
        function handleJoystickEnd(e) {
            if (!joystickActive) return;
            e.preventDefault();
            joystickActive = false;
            
            // Возвращаем джойстик в центр
            joystickKnob.style.transform = 'translate(-50%, -50%)';
            joystickX = 0;
            joystickY = 0;
            joystickAngle = 0;
            joystickDistance = 0;
        }
        
        function updateJoystickPosition(e) {
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // Вычисляем положение относительно центра джойстика
            joystickX = clientX - joystickCenterX;
            joystickY = clientY - joystickCenterY;
            
            // Ограничиваем расстояние до границ джойстика
            joystickDistance = Math.min(Math.sqrt(joystickX * joystickX + joystickY * joystickY), 30);
            joystickAngle = Math.atan2(joystickY, joystickX);
            
            // Нормализуем координаты, если вышли за пределы
            if (joystickDistance > 30) {
                joystickX = Math.cos(joystickAngle) * 30;
                joystickY = Math.sin(joystickAngle) * 30;
                joystickDistance = 30;
            }
            
            // Обновляем положение ручки джойстика
            joystickKnob.style.transform = `translate(${joystickX}px, ${joystickY}px) translate(-50%, -50%)`;
        }
        
        // Настройка кнопок действий (для мобильных)
        function setupActionButtons() {
            telekinesisBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                useTelekinesis();
            });
            
            telekinesisBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                useTelekinesis();
            });
            
            portalBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                usePortal();
            });
            
            portalBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                usePortal();
            });
        }
        
        // Управление клавиатурой (для ПК)
        function setupKeyboardControls() {
            window.addEventListener('keydown', (e) => {
                if (e.key in keys) {
                    keys[e.key] = true;
                    e.preventDefault();
                }
                
                // Перезапуск игры
                if (e.key.toLowerCase() === 'r' && !gameRunning) {
                    startGame();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key in keys) {
                    keys[e.key] = false;
                    e.preventDefault();
                }
            });
        }
        
        // Переключение звука
        function setupSoundToggle() {
            soundToggle.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                
                if (soundEnabled) {
                    soundToggle.textContent = '🔊';
                    bgMusic.volume = 0.3;
                    if (gameRunning) bgMusic.play().catch(e => console.log(e));
                } else {
                    soundToggle.textContent = '🔇';
                    bgMusic.pause();
                }
            });
        }
        
        // Определение типа устройства и настройка управления
        function setupControls() {
            // Проверяем, является ли устройство мобильным
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Показываем мобильные элементы управления
                mobileControls.style.display = 'block';
                actionButtons.style.display = 'flex';
                abilityCooldowns.style.display = 'flex';
                
                // Настраиваем джойстик и кнопки
                setupJoystick();
                setupActionButtons();
                
                // Обновляем информацию об управлении
                controlsInfo.textContent = "Управление: Джойстик - движение, кнопки - способности";
            } else {
                // Настраиваем управление с клавиатуры
                setupKeyboardControls();
                abilityCooldowns.style.display = 'flex';
                
                // Обновляем информацию об управлении
                controlsInfo.textContent = "Управление: Стрелки - движение, T - телекинез, P - портал, M - мини-карта, R - перезапуск";
            }
            
            // Настраиваем переключение звука
            setupSoundToggle();
        }
        
        // Показать финальную кат-сцену
        function showEndingScene() {
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.style.display = 'flex';
            
            // Прячем остальные элементы интерфейса
            document.getElementById('ui').style.display = 'none';
            document.getElementById('inventory').style.display = 'none';
            document.getElementById('fear-bar').style.display = 'none';
            document.getElementById('telekenesis-bar').style.display = 'none';
            document.getElementById('fear-label').style.display = 'none';
            document.getElementById('telekenesis-label').style.display = 'none';
            document.getElementById('room-indicator').style.display = 'none';
            document.getElementById('mini-map').style.display = 'none';
            
            // Анимируем появление элементов
            setTimeout(() => {
                document.getElementById('ending-image').classList.add('show');
            }, 2500);
            
            setTimeout(() => {
                document.getElementById('ending-button').classList.add('show');
            }, 3500);
            
            // Настраиваем кнопку "Играть снова"
            document.getElementById('ending-button').addEventListener('click', () => {
                endingScreen.style.display = 'none';
                startGame();
            });
        }
        
        // Запуск игры
        function startGame() {
            // Скрываем финальную кат-сцену
            document.getElementById('ending-screen').style.display = 'none';
            
            // Установка размеров canvas
            resizeCanvas();
            
            player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 20,
                speed: 3,
                health: 100,
                fear: 0,
                maxFear: 100,
                artifacts: 0,
                telekinesis: 0,
                maxTelekinesis: 100,
                telekinesisCooldown: 5000,
                lastTelekinesisUse: 0,
                portalCharges: 3,
                maxPortalCharges: 3,
                portalCooldown: 15000,
                lastPortalUse: 0,
                dogEnemiesNearby: 0,
                visitedRooms: new Set()
            };
            
            artifactCountElement.textContent = '0';
            healthFillElement.style.width = '100%';
            fearFillElement.style.width = '0%';
            telekenesisFillElement.style.width = '0%';
            darknessAlpha = 0.7;
            
            generateRooms();
            gameTime = 0;
            lastEnemySpawn = 0;
            lastFearIncrease = Date.now();
            lastTelekinesisIncrease = Date.now();
            
            startScreen.style.display = 'none';
            gameRunning = true;
            restartBtn.style.display = 'none';
            restartBtn.textContent = "РЕСТАРТ (R)";
            
            updateInventory();
            
            if (soundEnabled) {
                bgMusic.volume = 0.3;
                bgMusic.play().catch(e => console.log("Audio play failed:", e));
            }
            
            showDialog(story);
            
            // Запускаем обновление индикаторов перезарядки
            clearInterval(cooldownInterval);
            cooldownInterval = setInterval(updateCooldownIndicators, 100);
            
            update();
        }
        
        // Инициализация игры
        function init() {
            // Настраиваем управление в зависимости от устройства
            setupControls();
            
            // Кнопка "Далее" в диалоге
            dialogNext.addEventListener('click', nextDialog);
            dialogNext.addEventListener('touchstart', (e) => {
                e.preventDefault();
                nextDialog();
            });
            
            // Кнопка старта
            startButton.addEventListener('click', startGame);
            startButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startGame();
            });
            
            // Кнопка рестарта
            restartBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startGame();
            });
            
            // Обработчик изменения размера окна
            window.addEventListener('resize', resizeCanvas);
            
            // Начальная отрисовка
            resizeCanvas();
            draw();
        }
        
        // Запуск инициализации после загрузки страницы
        window.addEventListener('load', init);
    </script>
</body>
</html>
