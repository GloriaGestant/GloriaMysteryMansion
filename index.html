<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–µ–º–Ω—ã–π –æ—Å–æ–±–Ω—è–∫ - –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ì–ª–æ—Ä–∏–∏</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            image-rendering: pixelated;
            background-color: #111;
        }
        
        #game-canvas {
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            background-color: rgba(42, 26, 74, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 2;
        }
        
        #health-bar {
            width: 80px;
            height: 8px;
            background-color: #2a1a1a;
            margin-top: 5px;
            border: 1px solid #3d2a2a;
        }
        
        #health-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 100%;
            transition: width 0.3s;
        }
        
        #message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.9);
            padding: 10px 15px;
            border: 2px solid #b19cd9;
            max-width: 90%;
            text-align: center;
            display: none;
            font-size: 14px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
            z-index: 2;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="black"/><path d="M30,20 L50,10 L70,20 L65,50 L75,70 L50,80 L25,70 L35,50 Z" fill="%232a1a4a"/><circle cx="40" cy="40" r="5" fill="%23b19cd9"/><circle cx="60" cy="40" r="5" fill="%23b19cd9"/></svg>');
            background-size: 150px;
            background-repeat: repeat;
        }
        
        #title {
            font-size: 28px;
            color: #b19cd9;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #b19cd9, 0 0 20px #b19cd9;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
            text-align: center;
            padding: 0 10px;
        }
        
        #subtitle {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 30px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
            padding: 0 10px;
        }
        
        #controls {
            margin-top: 20px;
            font-size: 12px;
            color: #777;
            text-align: center;
            max-width: 90%;
        }
        
        button {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 2px solid #b19cd9;
            padding: 10px 25px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            transition: all 0.3s;
            border-radius: 5px;
        }
        
        button:hover {
            background-color: #3d2a5f;
            text-shadow: 0 0 5px #b19cd9;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
        }
        
        #dialog-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.9);
            padding: 10px;
            border: 2px solid #b19cd9;
            max-width: 80%;
            text-align: center;
            display: none;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
            z-index: 5;
            line-height: 1.6;
            font-size: 16px;
            animation: pulse 2s infinite;
        }
        
        #dialog-text {
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        #dialog-next {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 1px solid #b19cd9;
            padding: 5px 15px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            font-size: 14px;
        }
        
        #inventory {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(42, 26, 74, 0.7);
            padding: 8px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 2;
        }
        
        .inventory-item {
            width: 35px;
            height: 35px;
            background-color: rgba(58, 42, 90, 0.5);
            border: 1px solid #3d2a5f;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .inventory-item.active {
            border-color: #b19cd9;
            box-shadow: 0 0 5px #b19cd9;
        }
        
        .inventory-item img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated;
        }
        
        #fear-bar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 80px;
            height: 8px;
            background-color: #1a0a2a;
            margin-top: 5px;
            border: 1px solid #3d2a5f;
            z-index: 2;
        }
        
        #fear-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.3s;
        }
        
        #fear-label {
            position: absolute;
            bottom: 23px;
            left: 10px;
            font-size: 10px;
            color: #b19cd9;
            z-index: 2;
        }
        
        #telekenesis-bar {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 8px;
            background-color: #1a0a2a;
            margin-top: 5px;
            border: 1px solid #3d2a5f;
            z-index: 2;
        }
        
        #telekenesis-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.3s;
        }
        
        #telekenesis-label {
            position: absolute;
            bottom: 23px;
            right: 10px;
            font-size: 10px;
            color: #b19cd9;
            z-index: 2;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(177, 156, 217, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(177, 156, 217, 0.8); }
            100% { transform: scale(1); box-shadow: 0 0 10px rgba(177, 156, 217, 0.5); }
        }
        
        #flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            z-index: 1;
            opacity: 0.7;
            display: none;
        }
        
        #joystick {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: rgba(42, 26, 74, 0.5);
            border-radius: 50%;
            border: 2px solid #b19cd9;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }
        
        #joystick-knob {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(177, 156, 217, 0.7);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        #action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1;
            display: none;
        }
        
        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(42, 26, 74, 0.7);
            border: 2px solid #b19cd9;
            color: #b19cd9;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            text-align: center;
            touch-action: manipulation;
        }
        
        .action-btn:active {
            background-color: rgba(177, 156, 217, 0.3);
        }
        
        #restart-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(42, 26, 74, 0.7);
            border: 1px solid #b19cd9;
            color: #b19cd9;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 3;
            display: none;
            touch-action: manipulation;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ü–ö */
        @media (min-width: 768px) {
            #game-container {
                width: 800px;
                height: 600px;
            }
            
            #ui {
                font-size: 16px;
            }
            
            #health-bar {
                width: 100px;
                height: 10px;
            }
            
            #message-box {
                font-size: 18px;
                padding: 15px 20px;
            }
            
            #title {
                font-size: 48px;
                margin-bottom: 20px;
                letter-spacing: 3px;
            }
            
            #subtitle {
                font-size: 18px;
                margin-bottom: 40px;
            }
            
            #controls {
                font-size: 14px;
                margin-top: 30px;
            }
            
            button {
                padding: 12px 30px;
                margin: 10px;
                font-size: 18px;
            }
            
            #dialog-box {
                padding: 15px;
            }
            
            #dialog-text {
                font-size: 16px;
            }
            
            #inventory {
                padding: 10px;
            }
            
            .inventory-item {
                width: 40px;
                height: 40px;
            }
            
            #fear-bar, #telekenesis-bar {
                width: 100px;
                height: 10px;
            }
            
            #fear-label, #telekenesis-label {
                font-size: 12px;
                bottom: 25px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 767px) {
            #restart-btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        
        /* –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        #room-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(42, 26, 74, 0.7);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 2;
            display: none;
        }
        
        #ability-cooldowns {
            position: absolute;
            bottom: 50px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 2;
            display: none;
        }
        
        .cooldown-indicator {
            width: 80px;
            height: 8px;
            background-color: rgba(26, 10, 42, 0.7);
            border: 1px solid #3d2a5f;
            position: relative;
        }
        
        .cooldown-fill {
            height: 100%;
            background-color: #b19cd9;
            width: 0%;
            transition: width 0.1s;
        }
        
        .cooldown-label {
            position: absolute;
            top: -15px;
            left: 0;
            font-size: 10px;
            color: #b19cd9;
        }
        
        #mini-map {
            position: absolute;
            top: 60px;
            right: 10px;
            width: 100px;
            height: 100px;
            background-color: rgba(26, 10, 42, 0.5);
            border: 1px solid #3d2a5f;
            z-index: 2;
            display: none;
        }
        
        #mini-map-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2px;
            padding: 2px;
        }
        
        .mini-map-room {
            background-color: rgba(58, 42, 90, 0.3);
            border: 1px solid #3d2a5f;
            position: relative;
        }
        
        .mini-map-room.active {
            background-color: rgba(177, 156, 217, 0.3);
            border-color: #b19cd9;
        }
        
        .mini-map-room.visited {
            background-color: rgba(100, 80, 140, 0.3);
        }
        
        .mini-map-room.artifact {
            position: relative;
        }
        
        .mini-map-room.artifact::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background-color: #b19cd9;
            border-radius: 50%;
        }
        
        .mini-map-room.artifact.collected::after {
            display: none;
        }
        
        #sound-toggle {
            position: absolute;
            bottom: 10px;
            right: 100px;
            width: 30px;
            height: 30px;
            background-color: rgba(42, 26, 74, 0.7);
            border: 1px solid #b19cd9;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            cursor: pointer;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∫–∞—Ç-—Å—Ü–µ–Ω—ã */
        #ending-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: #b19cd9;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        #ending-title {
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #b19cd9;
            animation: pulse 2s infinite;
        }
        
        #ending-text {
            font-size: 18px;
            line-height: 1.6;
            max-width: 800px;
            margin-bottom: 30px;
        }
        
        #ending-image {
            width: 300px;
            height: 300px;
            margin: 20px 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%232a1a4a" stroke="%23b19cd9" stroke-width="2"/><path d="M30,40 Q50,20 70,40 Q80,60 50,80 Q20,60 30,40 Z" fill="%23b19cd9"/><circle cx="40" cy="40" r="5" fill="%232a1a4a"/><circle cx="60" cy="40" r="5" fill="%232a1a4a"/><path d="M40,60 Q50,70 60,60" fill="none" stroke="%232a1a4a" stroke-width="2"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
            transform: scale(0.5);
            transition: all 2s ease-out;
        }
        
        #ending-image.show {
            opacity: 1;
            transform: scale(1);
        }
        
        #ending-button {
            background-color: #2a1a4a;
            color: #b19cd9;
            border: 2px solid #b19cd9;
            padding: 12px 30px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin-top: 30px;
            font-size: 18px;
            transition: all 0.3s;
            border-radius: 5px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease-out 3s;
        }
        
        #ending-button:hover {
            background-color: #3d2a5f;
            text-shadow: 0 0 5px #b19cd9;
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.5);
        }
        
        #ending-button.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @keyframes textReveal {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .ending-paragraph {
            opacity: 0;
            transform: translateY(20px);
            animation: textReveal 1s forwards;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui">
            <div>–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: <span id="artifact-count">0</span>/7</div>
            <div>–ó–¥–æ—Ä–æ–≤—å–µ:</div>
            <div id="health-bar"><div id="health-fill"></div></div>
        </div>
        
        <div id="room-indicator">–ö–æ–º–Ω–∞—Ç–∞: –ü—Ä–∏—Ö–æ–∂–∞—è</div>
        
        <div id="fear-label">–°–¢–†–ê–•</div>
        <div id="fear-bar"><div id="fear-fill"></div></div>
        
        <div id="telekenesis-label">–¢–ï–õ–ï–ö–ò–ù–ï–ó</div>
        <div id="telekenesis-bar"><div id="telekenesis-fill"></div></div>
        
        <div id="inventory">
            <div class="inventory-item" data-item="telekenesis">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='6' fill='%23b19cd9'/><path d='M4,8 L12,8 M8,4 L8,12' stroke='%232a1a4a' stroke-width='2'/></svg>" alt="–¢–µ–ª–µ–∫–∏–Ω–µ–∑">
            </div>
            <div class="inventory-item" data-item="portal">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><circle cx='8' cy='8' r='7' fill='none' stroke='%23b19cd9' stroke-width='2'/><path d='M2,8 A6,6 0 0,1 14,8 A6,6 0 0,1 2,8' fill='%233d2a5f'/></svg>" alt="–ü–æ—Ä—Ç–∞–ª">
            </div>
        </div>
        
        <div id="ability-cooldowns">
            <div class="cooldown-indicator">
                <div class="cooldown-label">–¢–ï–õ–ï–ö–ò–ù–ï–ó</div>
                <div class="cooldown-fill" id="telekinesis-cooldown"></div>
            </div>
            <div class="cooldown-indicator">
                <div class="cooldown-label">–ü–û–†–¢–ê–õ</div>
                <div class="cooldown-fill" id="portal-cooldown"></div>
            </div>
        </div>
        
        <div id="mini-map">
            <div id="mini-map-grid"></div>
        </div>
        
        <div id="message-box"></div>
        
        <div id="dialog-box">
            <div id="dialog-text"></div>
            <button id="dialog-next">–î–∞–ª–µ–µ</button>
        </div>
        
        <div id="start-screen">
            <div id="title">–¢–ê–ô–ù–ê –ì–õ–û–†–ò–ò</div>
            <div id="subtitle">–ü–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞ –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏, –ì–ª–æ—Ä–∏—è –æ—á–Ω—É–ª–∞—Å—å –≤ —Å—Ç—Ä–∞–Ω–Ω–æ–º –æ—Å–æ–±–Ω—è–∫–µ...<br>–ï–µ –∫–æ—à–∞—á—å–∏ —á—É–≤—Å—Ç–≤–∞ —Å—Ä–∞–∑—É —É–ª–æ–≤–∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ª–∞–¥–Ω–æ–µ - —ç—Ç–æ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã –µ–µ –ø—Ä–æ—à–ª–æ–≥–æ.<br>–ù–∞–π–¥–∏ 7 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—É—Ç—å –¥–æ–º–æ–π.</div>
            <button id="start-button">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
            <div id="controls" class="controls-info">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
        </div>
        
        <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="mobile-controls">
            <div id="joystick">
                <div id="joystick-knob"></div>
            </div>
        </div>
        
        <div id="action-buttons">
            <div class="action-btn" id="telekinesis-btn">–¢–ï–õ–ï–ö–ò–ù–ï–ó</div>
            <div class="action-btn" id="portal-btn">–ü–û–†–¢–ê–õ</div>
        </div>
        
        <button id="restart-btn">–†–ï–°–¢–ê–†–¢ (R)</button>
        
        <div id="sound-toggle">üîä</div>
        
        <div id="flash"></div>

        <!-- –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–∞—Ç-—Å—Ü–µ–Ω–∞ -->
        <div id="ending-screen">
            <div id="ending-title">–ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò</div>
            <div id="ending-text">
                <div class="ending-paragraph" style="animation-delay: 0.5s">–ì–ª–æ—Ä–∏—è —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ø–æ –∫—Ä—É–≥—É –≤ —Ü–µ–Ω—Ç—Ä–µ –ø—Ä–∏—Ö–æ–∂–µ–π. –ö–∞–∂–¥—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–µ—Ç–∏—Ç—å—Å—è –º—è–≥–∫–∏–º —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º —Å–≤–µ—Ç–æ–º.</div>
                <div class="ending-paragraph" style="animation-delay: 1s">–í–Ω–µ–∑–∞–ø–Ω–æ —Å–≤–µ—Ç —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è, –∏ —Å—Ç–µ–Ω—ã –æ—Å–æ–±–Ω—è–∫–∞ –Ω–∞—á–∏–Ω–∞—é—Ç —Ä–∞—Å—Ç–≤–æ—Ä—è—Ç—å—Å—è, –æ–±–Ω–∞–∂–∞—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è...</div>
                <div class="ending-paragraph" style="animation-delay: 1.5s">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è. –ö–ª–µ—Ç–∫–∏. –ë–æ–ª—å. –ù–æ —Ç–∞–∫–∂–µ - –ø–æ–±–µ–≥, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–≤–æ–∏—Ö —Å–∏–ª.</div>
                <div class="ending-paragraph" style="animation-delay: 2s">–ì–æ–ª–æ—Å –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ: "–ì–ª–æ—Ä–∏—è, —Ç—ã –±—ã–ª–∞ –ª—É—á—à–∏–º –∏–∑ –Ω–∞—à–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è, –∫—Ç–æ –≤—ã–∂–∏–ª..."</div>
                <div class="ending-paragraph" style="animation-delay: 2.5s">–¢–µ–Ω–∏ –≤–æ–∫—Ä—É–≥ —Å–æ–¥—Ä–æ–≥–∞—é—Ç—Å—è, —Ü–µ–ø–ª—è—è—Å—å –∑–∞ –ì–ª–æ—Ä–∏—é, –Ω–æ —Å–≤–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Ä—á–µ.</div>
                <div id="ending-image"></div>
                <div class="ending-paragraph" style="animation-delay: 3s">–í—Å–ø—ã—à–∫–∞! –ì–ª–æ—Ä–∏—è —á—É–≤—Å—Ç–≤—É–µ—Ç, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ–∫—Ä—É–≥ –º–µ–Ω—è–µ—Ç—Å—è. –û–Ω–∞ –≤–∏–¥–∏—Ç –¥–æ—Ä–æ–≥—É –¥–æ–º–æ–π - —Ç—É—Å–∫–ª—ã–π —Å–≤–µ—Ç –≤ –∫–æ–Ω—Ü–µ —Ç—É–Ω–Ω–µ–ª—è.</div>
                <div class="ending-paragraph" style="animation-delay: 3.5s">–ü–æ—Å–ª–µ–¥–Ω–µ–µ, —á—Ç–æ –æ–Ω–∞ —Å–ª—ã—à–∏—Ç - –≥–æ–ª–æ—Å –æ—Å–æ–±–Ω—è–∫–∞: "–¢—ã –≤–µ—Ä–Ω–µ—à—å—Å—è... –û–Ω–∏ –≤—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è..."</div>
                <div class="ending-paragraph" style="animation-delay: 4s">–ù–û–í–ê–Ø –ì–õ–ê–í–ê</div>
                <div class="ending-paragraph" style="animation-delay: 4.5s">–ì–ª–æ—Ä–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–∑–∞. –û–Ω–∞ –ª–µ–∂–∏—Ç –Ω–∞ –º—è–≥–∫–æ–º –∫–æ–≤—Ä–µ –≤ –∑–Ω–∞–∫–æ–º–æ–π –∫–æ–º–Ω–∞—Ç–µ. –ó–∞ –æ–∫–Ω–æ–º - –ø—Ä–∏–≤—ã—á–Ω—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–µ–π–∑–∞–∂.</div>
                <div class="ending-paragraph" style="animation-delay: 5s">–ù–æ –≤ –∑–µ—Ä–∫–∞–ª–µ –æ–Ω–∞ –∑–∞–º–µ—á–∞–µ—Ç —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ - –µ–µ –≥–ª–∞–∑–∞ –∏–Ω–æ–≥–¥–∞ –º–µ—Ä—Ü–∞—é—Ç —Ç–µ–º –∂–µ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º —Å–≤–µ—Ç–æ–º, —á—Ç–æ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã...</div>
            </div>
            <button id="ending-button">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-dark-ambient-tribal-1231.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="artifactSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="hurtSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-jumping-in-a-video-game-2043.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="enemySound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-creature-cry-of-hurt-2208.mp3" type="audio/mpeg">
    </audio>

    <audio id="victorySound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="portalSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-magic-spell-669.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="telekinesisSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-quick-jump-arcade-game-239.mp3" type="audio/mpeg">
    </audio>

    <script>
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ì–ª–æ—Ä–∏–∏
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const artifactCountElement = document.getElementById('artifact-count');
        const healthFillElement = document.getElementById('health-fill');
        const fearFillElement = document.getElementById('fear-fill');
        const telekenesisFillElement = document.getElementById('telekenesis-fill');
        const messageBox = document.getElementById('message-box');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const dialogBox = document.getElementById('dialog-box');
        const dialogText = document.getElementById('dialog-text');
        const dialogNext = document.getElementById('dialog-next');
        const inventoryItems = document.querySelectorAll('.inventory-item');
        const flash = document.getElementById('flash');
        const restartBtn = document.getElementById('restart-btn');
        const controlsInfo = document.querySelector('.controls-info');
        const roomIndicator = document.getElementById('room-indicator');
        const miniMap = document.getElementById('mini-map');
        const miniMapGrid = document.getElementById('mini-map-grid');
        const soundToggle = document.getElementById('sound-toggle');
        
        // –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystick-knob');
        const telekinesisBtn = document.getElementById('telekinesis-btn');
        const portalBtn = document.getElementById('portal-btn');
        const mobileControls = document.getElementById('mobile-controls');
        const actionButtons = document.getElementById('action-buttons');
        const abilityCooldowns = document.getElementById('ability-cooldowns');
        const telekinesisCooldown = document.getElementById('telekinesis-cooldown');
        const portalCooldown = document.getElementById('portal-cooldown');
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // –ó–≤—É–∫–∏
        const bgMusic = document.getElementById('bgMusic');
        const artifactSound = document.getElementById('artifactSound');
        const hurtSound = document.getElementById('hurtSound');
        const enemySound = document.getElementById('enemySound');
        const victorySound = document.getElementById('victorySound');
        const portalSound = document.getElementById('portalSound');
        const telekinesisSound = document.getElementById('telekinesisSound');
        
        let soundEnabled = true;
        let gameRunning = false;
        let player = {
            x: 400,
            y: 300,
            size: 20,
            speed: 3,
            health: 100,
            fear: 0,
            maxFear: 100,
            artifacts: 0,
            telekinesis: 0,
            maxTelekinesis: 100,
            telekinesisCooldown: 5000,
            lastTelekinesisUse: 0,
            portalCharges: 3,
            maxPortalCharges: 3,
            portalCooldown: 15000,
            lastPortalUse: 0,
            dogEnemiesNearby: 0,
            visitedRooms: new Set()
        };
        
        let artifacts = [];
        let enemies = [];
        let lastEnemySpawn = 0;
        let gameTime = 0;
        let messageTimeout;
        let dialog = [];
        let currentDialog = 0;
        let rooms = [];
        let currentRoom = 0;
        let darknessAlpha = 0.7;
        let lastFearIncrease = 0;
        let lastTelekinesisIncrease = 0;
        let cooldownInterval;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        let isMobile = false;
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (–¥–ª—è –ü–ö)
        let keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            KeyT: false,
            KeyP: false,
            KeyM: false
        };
        
        // –î–∂–æ–π—Å—Ç–∏–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
        let joystickActive = false;
        let joystickCenterX = 0;
        let joystickCenterY = 0;
        let joystickX = 0;
        let joystickY = 0;
        let joystickAngle = 0;
        let joystickDistance = 0;
        
        // –ò—Å—Ç–æ—Ä–∏—è –∏ –¥–∏–∞–ª–æ–≥–∏
        const story = [
            "–ü–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –ø—Ä—ã–∂–∫–∞ –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏, –ì–ª–æ—Ä–∏—è –æ—á–Ω—É–ª–∞—Å—å –≤ —Å—Ç—Ä–∞–Ω–Ω–æ–º –æ—Å–æ–±–Ω—è–∫–µ...",
            "–ï–µ –∫–æ—à–∞—á—å–∏ —á—É–≤—Å—Ç–≤–∞ —Å—Ä–∞–∑—É —É–ª–æ–≤–∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ª–∞–¥–Ω–æ–µ - —ç—Ç–æ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã –µ–µ –ø—Ä–æ—à–ª–æ–≥–æ.",
            "–ì–æ–ª–æ—Å –≤ –≥–æ–ª–æ–≤–µ –ø—Ä–æ—à–µ–ø—Ç–∞–ª: '–ù–∞–π–¥–∏ 7 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–≤–æ–µ–π –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—É—Ç—å –¥–æ–º–æ–π...'",
            "–ù–æ –æ—Å–æ–±–Ω—è–∫ –Ω–µ —Ö–æ—á–µ—Ç –æ—Ç–ø—É—Å–∫–∞—Ç—å —Å–≤–æ—é –¥–æ–±—ã—á—É. –¢–µ–Ω–∏ —à–µ–ø—á—É—Ç—Å—è –æ –ø—Ä–æ—à–ª—ã—Ö –∂–µ—Ä—Ç–≤–∞—Ö.",
            "–ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏: —Ç–µ–ª–µ–∫–∏–Ω–µ–∑ –∏ –ø–æ—Ä—Ç–∞–ª—ã, –Ω–æ –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–∞ - –æ–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã.",
            "–¢–≤–æ—è –∫–æ—à–∞—á—å—è –ø—Ä–∏—Ä–æ–¥–∞ –¥–∞–µ—Ç —Ç–µ–±–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –Ω–æ –∏ –¥–µ–ª–∞–µ—Ç —É—è–∑–≤–∏–º–æ–π –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º..."
        ];
        
        const roomNames = [
            "–ü—Ä–∏—Ö–æ–∂–∞—è", "–ì–æ—Å—Ç–∏–Ω–∞—è", "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞", "–°—Ç–æ–ª–æ–≤–∞—è",
            "–ö—É—Ö–Ω—è", "–ö–∞–±–∏–Ω–µ—Ç", "–î–µ—Ç—Å–∫–∞—è", "–ß–µ—Ä–¥–∞–∫"
        ];
        
        const roomDescriptions = [
            "–°—Ç–µ–Ω—ã —É–∫—Ä–∞—à–µ–Ω—ã –ø–æ—Ä—Ç—Ä–µ—Ç–∞–º–∏ –∫–æ—à–µ–∫ —Å –ø—É—Å—Ç—ã–º–∏ –≥–ª–∞–∑–Ω–∏—Ü–∞–º–∏. –ì–ª–æ—Ä–∏—è —á—É–≤—Å—Ç–≤—É–µ—Ç, –∫–∞–∫ –µ–µ —Ö–≤–æ—Å—Ç –Ω–µ–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ –≤–∑–¥—ã–±–ª–∏–≤–∞–µ—Ç—Å—è.",
            "–†–∞–∑–≤–∞–ª–∏–≤—à–µ–µ—Å—è –∫—Ä–µ—Å–ª–æ-–∫–∞—á–∞–ª–∫–∞ –≤—Å–µ –µ—â–µ –¥–≤–∏–∂–µ—Ç—Å—è. –ù–∞ –ø–æ–ª—É - —Å–ª–µ–¥—ã –∫–æ–≥—Ç–µ–π, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–π –∫–æ—à–∫–∏...",
            "–ö–Ω–∏–≥–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ '–ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤' –∏ '–ì–∏–±—Ä–∏–¥—ã —á–µ–ª–æ–≤–µ–∫–∞ –∏ –∂–∏–≤–æ—Ç–Ω–æ–≥–æ'. –ì–ª–æ—Ä–∏—é –±—Ä–æ—Å–∞–µ—Ç –≤ –¥—Ä–æ–∂—å.",
            "–ù–∞ —Å—Ç–æ–ª–µ - —Å–µ–º—å —Ç–∞—Ä–µ–ª–æ–∫ —Å —á–µ–º-—Ç–æ, —á—Ç–æ –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª–æ –µ–¥–æ–π. –ù–∞ –æ–¥–Ω–æ–π - –æ—à–µ–π–Ω–∏–∫ —Å –∏–º–µ–Ω–µ–º '–ú–æ—è–æ'...",
            "–ó–∞–ø–∞—Ö –≥–Ω–∏—é—â–µ–≥–æ –º—è—Å–∞ —Å–º–µ—à–∏–≤–∞–µ—Ç—Å—è —Å –∞—Ä–æ–º–∞—Ç–æ–º –≤–∞–ª–µ—Ä—å—è–Ω–∫–∏. –ù–æ–∂–∏ –≤–∏—Å—è—Ç –Ω–∞ —Å—Ç–µ–Ω–µ –≤ –∏–¥–µ–∞–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.",
            "–°—Ç–µ–Ω—ã –∏—Å–ø–µ—â—Ä–µ–Ω—ã —á–µ—Ä—Ç–µ–∂–∞–º–∏ –Ω–µ–∫–∏—Ö —Å—É—â–µ—Å—Ç–≤. –ù–∞ —Å—Ç–æ–ª–µ - —à–ø—Ä–∏—Ü—ã —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∂–∏–¥–∫–æ—Å—Ç—å—é. –ì–ª–æ—Ä–∏—è —á—É–≤—Å—Ç–≤—É–µ—Ç, –∫–∞–∫ —É—á–∞—â–∞–µ—Ç—Å—è –µ–µ –ø—É–ª—å—Å.",
            "–ò–≥—Ä—É—à–µ—á–Ω—ã–µ —Å–æ–±–∞–∫–∏ —Å –≥–æ—Ä—è—â–∏–º–∏ –∫—Ä–∞—Å–Ω—ã–º–∏ –≥–ª–∞–∑–∞–º–∏. –ö–æ–ª—ã–±–µ–ª—å –∫–∞—á–∞–µ—Ç—Å—è, —Ö–æ—Ç—è –≤ –∫–æ–º–Ω–∞—Ç–µ –Ω–µ—Ç –Ω–∏ –º–∞–ª–µ–π—à–µ–≥–æ –≤–µ—Ç–µ—Ä–∫–∞...",
            "–ó–¥–µ—Å—å —Ç–µ–º–Ω–µ–µ –≤—Å–µ–≥–æ. –í —É–≥–ª—É - –∫–ª–µ—Ç–∫–∞ —Å —Ü–∞—Ä–∞–ø–∏–Ω–∞–º–∏ –∏–∑–Ω—É—Ç—Ä–∏. –ì–ª–æ—Ä–∏—è —Å–ª—ã—à–∏—Ç —Ç–∏—Ö–æ–µ –º—è—É–∫–∞–Ω—å–µ, –Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –∑–≤—É–∫–∞ –Ω–∞–π—Ç–∏ –Ω–µ –º–æ–∂–µ—Ç."
        ];
        
        const enemyTypes = [
            { 
                name: "–¢–µ–Ω—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ç–æ—Ä–∞", 
                type: "humanoid", 
                speed: 1.2, 
                size: 20, 
                color: '#3a1a4a', 
                fear: 5,
                trigger: "–ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è, —à–µ–ø—á–∞ —á—Ç–æ-—Ç–æ –æ '–ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö' –∏ '—É–ª—É—á—à–µ–Ω–∏—è—Ö'",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-creature-cry-of-hurt-2208.mp3"
            },
            { 
                name: "–ü–µ—Å —Ç—å–º—ã", 
                type: "dog", 
                speed: 1.8, 
                size: 24, 
                color: '#5a1a1a', 
                fear: 15,
                trigger: "–†—ã—á–∏—Ç –∏ —Å–∫–∞–ª–∏—Ç—Å—è, –Ω–∞–ø–æ–º–∏–Ω–∞—è –ì–ª–æ—Ä–∏–∏ –æ –µ–µ —Å—Ç—Ä–∞—Ö–µ –ø–µ—Ä–µ–¥ —Å–æ–±–∞–∫–∞–º–∏",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-angry-dog-barking-35.mp3"
            },
            { 
                name: "–®–ø—Ä–∏—Ü–µ–≤–∞—è —Ç–µ–Ω—å", 
                type: "syringe", 
                speed: 1.3, 
                size: 16, 
                color: '#1a4a3a', 
                fear: 20,
                trigger: "–î–µ—Ä–∂–∏—Ç –≤ —Ä—É–∫–∞—Ö –æ–≥—Ä–æ–º–Ω—ã–π —à–ø—Ä–∏—Ü, –∫–∞–ø–∞—é—â–∏–π —Å—Ç—Ä–∞–Ω–Ω–æ–π –∂–∏–¥–∫–æ—Å—Ç—å—é",
                sound: "https://assets.mixkit.co/sfx/preview/mixkit-horror-needle-2669.mp3"
            }
        ];
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç
        function generateRooms() {
            rooms = [];
            for (let i = 0; i < 8; i++) {
                rooms.push({
                    name: roomNames[i],
                    width: canvas.width,
                    height: canvas.height,
                    description: roomDescriptions[i],
                    artifacts: [],
                    enemies: []
                });
            }
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º 7 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º
            let artifactsToPlace = 7;
            for (let i = 0; i < rooms.length && artifactsToPlace > 0; i++) {
                const artifactsInRoom = Math.min(Math.floor(Math.random() * 2) + 1, artifactsToPlace);
                for (let j = 0; j < artifactsInRoom; j++) {
                    rooms[i].artifacts.push({
                        x: Math.floor(Math.random() * (rooms[i].width - 40)) + 20,
                        y: Math.floor(Math.random() * (rooms[i].height - 40)) + 20,
                        collected: false
                    });
                }
                artifactsToPlace -= artifactsInRoom;
            }
            
            currentRoom = 0;
            player.visitedRooms.add(currentRoom);
            artifacts = rooms[currentRoom].artifacts;
            enemies = rooms[currentRoom].enemies;
            updateRoomIndicator();
            updateMiniMap();
            showMessage(rooms[currentRoom].description);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã
        function updateRoomIndicator() {
            roomIndicator.textContent = `–ö–æ–º–Ω–∞—Ç–∞: ${rooms[currentRoom].name}`;
            roomIndicator.style.display = 'block';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏-–∫–∞—Ä—Ç—ã
        function updateMiniMap() {
            miniMapGrid.innerHTML = '';
            
            for (let i = 0; i < rooms.length; i++) {
                const roomElement = document.createElement('div');
                roomElement.className = 'mini-map-room';
                
                if (i === currentRoom) {
                    roomElement.classList.add('active');
                } else if (player.visitedRooms.has(i)) {
                    roomElement.classList.add('visited');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –Ω–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
                const hasArtifacts = rooms[i].artifacts.some(a => !a.collected);
                if (hasArtifacts) {
                    roomElement.classList.add('artifact');
                }
                
                // –ï—Å–ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ–±—Ä–∞–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å collected
                if (rooms[i].artifacts.every(a => a.collected)) {
                    roomElement.classList.add('collected');
                }
                
                miniMapGrid.appendChild(roomElement);
            }
            
            miniMap.style.display = 'block';
        }
        
        // –°–º–µ–Ω–∞ –∫–æ–º–Ω–∞—Ç—ã
        function changeRoom(direction) {
            if (!gameRunning) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
            if (direction === 'left' && player.x <= player.size) {
                if (currentRoom > 0) {
                    currentRoom--;
                    player.x = canvas.width - player.size - 1;
                } else {
                    player.x = player.size;
                    return;
                }
            } else if (direction === 'right' && player.x >= canvas.width - player.size) {
                if (currentRoom < rooms.length - 1) {
                    currentRoom++;
                    player.x = player.size + 1;
                } else {
                    player.x = canvas.width - player.size;
                    return;
                }
            } else if (direction === 'up' && player.y <= player.size) {
                if (currentRoom > 3) {
                    currentRoom -= 4;
                    player.y = canvas.height - player.size - 1;
                } else {
                    player.y = player.size;
                    return;
                }
            } else if (direction === 'down' && player.y >= canvas.height - player.size) {
                if (currentRoom < 4) {
                    currentRoom += 4;
                    player.y = player.size + 1;
                } else {
                    player.y = canvas.height - player.size;
                    return;
                }
            } else {
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ –ø–æ—Å–µ—â–µ–Ω–Ω—ã–µ
            player.visitedRooms.add(currentRoom);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
            artifacts = rooms[currentRoom].artifacts;
            enemies = rooms[currentRoom].enemies;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞—Ö –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
            player.fear += 10;
            if (player.fear > player.maxFear) player.fear = player.maxFear;
            updateFearBar();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            updateRoomIndicator();
            updateMiniMap();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            showMessage(rooms[currentRoom].description);
            
            // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤ –≤ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ (—Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 50%)
            if (enemies.length === 0 && Math.random() > 0.5) {
                spawnEnemy();
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–∞–≥–æ–≤
        function spawnEnemy() {
            if (enemies.length >= 3 + Math.floor(gameTime / 1500)) return;
            
            let side = Math.floor(Math.random() * 4);
            let x, y;
            
            if (side === 0) {
                x = Math.random() * canvas.width;
                y = -20;
            } else if (side === 1) {
                x = canvas.width + 20;
                y = Math.random() * canvas.height;
            } else if (side === 2) {
                x = Math.random() * canvas.width;
                y = canvas.height + 20;
            } else {
                x = -20;
                y = Math.random() * canvas.height;
            }
            
            const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            
            enemies.push({
                x: x,
                y: y,
                size: type.size,
                speed: type.speed,
                color: type.color,
                fear: type.fear,
                type: type.type,
                angle: Math.atan2(player.y - y, player.x - x),
                active: true,
                flashTimer: 0,
                sound: type.sound
            });
            
            if (soundEnabled) {
                enemySound.src = type.sound;
                enemySound.currentTime = 0;
                enemySound.play().catch(e => console.log("Audio play failed:", e));
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, duration = 3000) {
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥
        function showDialog(texts) {
            dialog = texts;
            currentDialog = 0;
            dialogText.textContent = dialog[currentDialog];
            dialogBox.style.display = 'block';
            gameRunning = false;
        }
        
        // –°–ª–µ–¥—É—é—â–∞—è —Ä–µ–ø–ª–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞
        function nextDialog() {
            currentDialog++;
            if (currentDialog < dialog.length) {
                dialogText.textContent = dialog[currentDialog];
            } else {
                dialogBox.style.display = 'none';
                gameRunning = true;
                update();
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        function checkCollision(x1, y1, size1, x2, y2, size2) {
            return (
                x1 < x2 + size2 &&
                x1 + size1 > x2 &&
                y1 < y2 + size2 &&
                y1 + size1 > y2
            );
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∫–∞–ª—ã —Å—Ç—Ä–∞—Ö–∞
        function updateFearBar() {
            fearFillElement.style.width = player.fear + '%';
            
            if (player.fear < 30) {
                fearFillElement.style.backgroundColor = '#b19cd9';
            } else if (player.fear < 70) {
                fearFillElement.style.backgroundColor = '#a18cd9';
            } else {
                fearFillElement.style.backgroundColor = '#917cd9';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∫–∞–ª—ã —Ç–µ–ª–µ–∫–∏–Ω–µ–∑–∞
        function updateTelekinesisBar() {
            telekenesisFillElement.style.width = player.telekinesis + '%';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
        function updateCooldownIndicators() {
            const now = Date.now();
            
            // –¢–µ–ª–µ–∫–∏–Ω–µ–∑
            const telekinesisTimeLeft = player.telekinesisCooldown - (now - player.lastTelekinesisUse);
            const telekinesisPercent = Math.max(0, Math.min(100, 100 - (telekinesisTimeLeft / player.telekinesisCooldown * 100)));
            telekinesisCooldown.style.width = telekinesisPercent + '%';
            
            // –ü–æ—Ä—Ç–∞–ª
            const portalTimeLeft = player.portalCooldown - (now - player.lastPortalUse);
            const portalPercent = Math.max(0, Math.min(100, 100 - (portalTimeLeft / player.portalCooldown * 100)));
            portalCooldown.style.width = portalPercent + '%';
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ–∫–∏–Ω–µ–∑–∞
        function useTelekinesis() {
            const now = Date.now();
            if (player.telekinesis < 30 || now - player.lastTelekinesisUse < player.telekinesisCooldown) return;
            
            player.lastTelekinesisUse = now;
            
            // –û—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –≤—Ä–∞–≥–æ–≤
            enemies.forEach(enemy => {
                if (enemy.active) {
                    const angle = Math.atan2(enemy.y - player.y, enemy.x - player.x);
                    enemy.x += Math.cos(angle) * 50;
                    enemy.y += Math.sin(angle) * 50;
                    enemy.speed *= 0.5;
                    
                    // –û—Å–æ–±—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –≤—Ä–∞–≥–æ–≤-—Å–æ–±–∞–∫
                    if (enemy.type === "dog") {
                        enemy.speed *= 0.3;
                        player.fear -= 10;
                        if (player.fear < 0) player.fear = 0;
                    }
                }
            });
            
            player.telekinesis = 0;
            updateTelekinesisBar();
            
            showMessage("–¢–µ–ª–µ–∫–∏–Ω–µ–∑! –¢–µ–Ω–∏ –æ—Ç—à–≤—ã—Ä–Ω—É—Ç—ã –ø—Ä–æ—á—å!", 1500);
            
            if (soundEnabled) {
                telekinesisSound.currentTime = 0;
                telekinesisSound.play().catch(e => console.log("Audio play failed:", e));
            }
            
            flash.style.backgroundColor = "#b19cd9";
            flash.style.opacity = 0.3;
            setTimeout(() => {
                flash.style.opacity = 0;
            }, 300);
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–∞–ª–∞
        function usePortal() {
            const now = Date.now();
            if (player.portalCharges <= 0 || now - player.lastPortalUse < player.portalCooldown) return;
            
            player.lastPortalUse = now;
            player.portalCharges--;
            
            let safeSpot = false;
            let attempts = 0;
            
            while (!safeSpot && attempts < 10) {
                player.x = Math.floor(Math.random() * (canvas.width - 100)) + 50;
                player.y = Math.floor(Math.random() * (canvas.height - 100)) + 50;
                
                safeSpot = true;
                for (const enemy of enemies) {
                    const dist = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                    if (dist < 150) {
                        safeSpot = false;
                        break;
                    }
                }
                attempts++;
            }
            
            updateInventory();
            
            showMessage("–ü–æ—Ä—Ç–∞–ª –æ—Ç–∫—Ä—ã—Ç! –ì–ª–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ.", 1500);
            
            if (soundEnabled) {
                portalSound.currentTime = 0;
                portalSound.play().catch(e => console.log("Audio play failed:", e));
            }
            
            flash.style.backgroundColor = "#3d2a5f";
            flash.style.opacity = 0.5;
            setTimeout(() => {
                flash.style.opacity = 0;
            }, 500);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function updateInventory() {
            inventoryItems.forEach(item => {
                item.classList.remove('active');
                
                if (item.dataset.item === 'telekenesis') {
                    const now = Date.now();
                    if (player.telekinesis >= 30 && now - player.lastTelekinesisUse > player.telekinesisCooldown) {
                        item.classList.add('active');
                    }
                }
                
                if (item.dataset.item === 'portal') {
                    if (player.portalCharges > 0 && Date.now() - player.lastPortalUse > player.portalCooldown) {
                        item.classList.add('active');
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function update() {
            if (!gameRunning) return;
            
            gameTime++;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–º
            if (isMobile) {
                // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–∂–æ–π—Å—Ç–∏–∫
                if (joystickActive) {
                    const speedFactor = joystickDistance / 30;
                    player.x += Math.cos(joystickAngle) * player.speed * speedFactor;
                    player.y += Math.sin(joystickAngle) * player.speed * speedFactor;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –∫–æ–º–Ω–∞—Ç—ã
                    if (player.x <= player.size) {
                        changeRoom('left');
                    } else if (player.x >= canvas.width - player.size) {
                        changeRoom('right');
                    }
                    
                    if (player.y <= player.size) {
                        changeRoom('up');
                    } else if (player.y >= canvas.height - player.size) {
                        changeRoom('down');
                    }
                }
            } else {
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                if (keys.ArrowUp) {
                    player.y -= player.speed;
                    changeRoom('up');
                }
                if (keys.ArrowDown) {
                    player.y += player.speed;
                    changeRoom('down');
                }
                if (keys.ArrowLeft) {
                    player.x -= player.speed;
                    changeRoom('left');
                }
                if (keys.ArrowRight) {
                    player.x += player.speed;
                    changeRoom('right');
                }
                
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ–∫–∏–Ω–µ–∑–∞ (T)
                if (keys.KeyT && player.telekinesis >= 30 && Date.now() - player.lastTelekinesisUse > player.telekinesisCooldown) {
                    useTelekinesis();
                    keys.KeyT = false;
                }
                
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–∞–ª–∞ (P)
                if (keys.KeyP && player.portalCharges > 0 && Date.now() - player.lastPortalUse > player.portalCooldown) {
                    usePortal();
                    keys.KeyP = false;
                }
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∏–Ω–∏-–∫–∞—Ä—Ç—ã (M)
                if (keys.KeyM) {
                    miniMap.style.display = miniMap.style.display === 'none' ? 'block' : 'none';
                    keys.KeyM = false;
                }
            }
            
            // –ì—Ä–∞–Ω–∏—Ü—ã –∏–≥—Ä–æ–∫–∞
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ–∫–∏–Ω–µ–∑–∞
            const now = Date.now();
            if (now - lastTelekinesisIncrease > 1000 && player.telekinesis < player.maxTelekinesis) {
                player.telekinesis += 1;
                lastTelekinesisIncrease = now;
                updateTelekinesisBar();
                updateInventory();
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ä—è–¥–æ–≤ –ø–æ—Ä—Ç–∞–ª–∞
            if (player.portalCharges < player.maxPortalCharges && now - player.lastPortalUse > player.portalCooldown) {
                player.portalCharges = player.maxPortalCharges;
                updateInventory();
                showMessage("–ü–æ—Ä—Ç–∞–ª—ã –ø–µ—Ä–µ–∑–∞—Ä—è–∂–µ–Ω—ã!", 2000);
            }
            
            // –ö–æ—à–∞—á—å–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            if (Math.random() < 0.005 && player.fear < 50) {
                const hints = [
                    "–ì–¥–µ-—Ç–æ –≤–¥–∞–ª–µ–∫–µ —Å–ª—ã—à–∏—Ç—Å—è –º—è—É–∫–∞–Ω—å–µ... –ú–æ–∂–µ—Ç, —ç—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞?",
                    "–ö–æ—à–∞—á—å–∏ —É—à–∏ —É–ª–∞–≤–ª–∏–≤–∞—é—Ç —à–µ–ø–æ—Ç: '–ò—â–∏ —Ç–∞–º, –≥–¥–µ —Ç–µ–º–Ω–µ–µ –≤—Å–µ–≥–æ...'",
                    "–ù–æ—Å —É—á—É—è–ª —Å–ª–∞–±—ã–π –∑–∞–ø–∞—Ö –≤–∞–ª–µ—Ä—å—è–Ω–∫–∏, –∏—Å—Ö–æ–¥—è—â–∏–π –æ—Ç –æ–¥–Ω–æ–π –∏–∑ —Å—Ç–µ–Ω...",
                    "–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–≤–µ—Ç—è—Ç—Å—è —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º... –∏—â–∏ —Å–≤–µ—Ç –≤ —Ç–µ–º–Ω–æ—Ç–µ'",
                    "–ò–Ω—Å—Ç–∏–Ω–∫—Ç—ã –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—é—Ç: –æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ä—è–¥–æ–º, –∫–æ–≥–¥–∞ —Ö–≤–æ—Å—Ç –≤–∑–¥—ã–±–ª–∏–≤–∞–µ—Ç—Å—è"
                ];
                showMessage(hints[Math.floor(Math.random() * hints.length)]);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–∞
            if (now - lastFearIncrease > 3000) {
                let fearIncrease = 1;
                
                fearIncrease += Math.floor(player.fear / 30);
                
                player.dogEnemiesNearby = 0;
                
                enemies.forEach(enemy => {
                    if (enemy.active) {
                        const dist = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                        
                        if (dist < 200) {
                            if (enemy.type === "dog") {
                                fearIncrease += 3;
                                player.dogEnemiesNearby++;
                            } else if (enemy.type === "syringe") {
                                fearIncrease += 4;
                            } else {
                                fearIncrease += 1;
                            }
                        }
                    }
                });
                
                player.fear += fearIncrease;
                lastFearIncrease = now;
                
                if (player.fear > player.maxFear) {
                    player.fear = player.maxFear;
                    
                    player.health -= 0.5;
                    healthFillElement.style.width = player.health + '%';
                    
                    if (player.health <= 0) {
                        showMessage("–ü–ê–ù–ò–ß–ï–°–ö–ê–Ø –ê–¢–ê–ö–ê! –ì–ª–æ—Ä–∏—è —Ç–µ—Ä—è–µ—Ç —Å–æ–∑–Ω–∞–Ω–∏–µ... –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞", 5000);
                        gameRunning = false;
                        restartBtn.style.display = 'block';
                    }
                }
                
                updateFearBar();
            }
            
            // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—Ç—Ä–∞—Ö–∞
            if (player.fear > 70) {
                darknessAlpha = 0.8 - (player.fear / 250);
                
                if (Math.random() < 0.02) {
                    ctx.fillStyle = `rgba(177, 156, 217, ${Math.random() * 0.1})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                darknessAlpha = 0.7;
            }
            
            // –°–±–æ—Ä –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
            artifacts.forEach(artifact => {
                if (!artifact.collected && checkCollision(
                    player.x - player.size/2, player.y - player.size/2, player.size,
                    artifact.x - 8, artifact.y - 8, 16
                )) {
                    artifact.collected = true;
                    player.artifacts++;
                    artifactCountElement.textContent = player.artifacts;
                    
                    if (soundEnabled) {
                        artifactSound.currentTime = 0;
                        artifactSound.play().catch(e => console.log("Audio play failed:", e));
                    }
                    
                    showMessage('–ê—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–∞–º—è—Ç–∏ –Ω–∞–π–¥–µ–Ω! ' + player.artifacts + '/7', 2000);
                    
                    player.fear = Math.max(0, player.fear - 15);
                    updateFearBar();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏-–∫–∞—Ä—Ç—É
                    updateMiniMap();
                    
                    if (player.artifacts === 7) {
                        showMessage('–í—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã! –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –ø—Ä–∏—Ö–æ–∂—É—é, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–º—è—Ç—å.', 5000);
                    }
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
            if (player.artifacts === 7 && currentRoom === 0 && 
                checkCollision(player.x, player.y, player.size, 50, 50, 100)) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É
                gameRunning = false;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É–∑—ã–∫—É –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫
                bgMusic.pause();
                if (soundEnabled) {
                    victorySound.volume = 0.5;
                    victorySound.play().catch(e => console.log(e));
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ç-—Å—Ü–µ–Ω—É
                showEndingScene();
            }
            
            // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
            if (gameTime - lastEnemySpawn > 300 && enemies.length < 3 + Math.floor(gameTime / 1500)) {
                spawnEnemy();
                lastEnemySpawn = gameTime;
            }
            
            // –î–≤–∏–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
            enemies.forEach(enemy => {
                if (enemy.active) {
                    enemy.x += Math.cos(enemy.angle) * enemy.speed;
                    enemy.y += Math.sin(enemy.angle) * enemy.speed;
                    
                    const distToPlayer = Math.sqrt(Math.pow(enemy.x - player.x, 2) + Math.pow(enemy.y - player.y, 2));
                    if (distToPlayer < 300) {
                        enemy.angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
                    if (checkCollision(
                        player.x - player.size/2, player.y - player.size/2, player.size,
                        enemy.x - enemy.size/2, enemy.y - enemy.size/2, enemy.size
                    )) {
                        player.health -= 5;
                        healthFillElement.style.width = player.health + '%';
                        
                        if (soundEnabled) {
                            hurtSound.currentTime = 0;
                            hurtSound.play().catch(e => console.log("Audio play failed:", e));
                        }
                        
                        player.fear += enemy.fear;
                        updateFearBar();
                        
                        if (player.health <= 0) {
                            showMessage("–í–´ –ü–û–ì–ò–ë–õ–ò... –ù–ê–ñ–ú–ò–¢–ï –ö–ù–û–ü–ö–£ –†–ï–°–¢–ê–†–¢–ê", 5000);
                            gameRunning = false;
                            restartBtn.style.display = 'block';
                        }
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
            updateCooldownIndicators();
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            draw();
            
            requestAnimationFrame(update);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–º–Ω–∞—Ç—ã
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(50, 50, canvas.width - 100, canvas.height - 100);
            
            ctx.strokeStyle = '#3a2a5a';
            ctx.lineWidth = 3;
            ctx.strokeRect(50, 50, canvas.width - 100, canvas.height - 100);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–≤–µ—Ä–µ–π
            ctx.fillStyle = '#2a1a3a';
            if (currentRoom > 0) {
                ctx.fillRect(40, canvas.height/2 - 30, 10, 60);
            }
            if (currentRoom < rooms.length - 1) {
                ctx.fillRect(canvas.width - 50, canvas.height/2 - 30, 10, 60);
            }
            if (currentRoom > 3) {
                ctx.fillRect(canvas.width/2 - 30, 40, 60, 10);
            }
            if (currentRoom < 4) {
                ctx.fillRect(canvas.width/2 - 30, canvas.height - 50, 60, 10);
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
            artifacts.forEach(artifact => {
                if (!artifact.collected) {
                    // –û—Å–Ω–æ–≤–∞
                    ctx.fillStyle = '#3d2a5f';
                    ctx.beginPath();
                    ctx.arc(artifact.x, artifact.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –°–∏–º–≤–æ–ª
                    ctx.strokeStyle = '#b19cd9';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(artifact.x - 5, artifact.y);
                    ctx.lineTo(artifact.x + 5, artifact.y);
                    ctx.moveTo(artifact.x, artifact.y - 5);
                    ctx.lineTo(artifact.x, artifact.y + 5);
                    ctx.stroke();
                    
                    // –°–≤–µ—á–µ–Ω–∏–µ
                    let gradient = ctx.createRadialGradient(
                        artifact.x, artifact.y, 0,
                        artifact.x, artifact.y, 40
                    );
                    gradient.addColorStop(0, 'rgba(177, 156, 217, 0.6)');
                    gradient.addColorStop(1, 'rgba(177, 156, 217, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(artifact.x, artifact.y, 40, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
            enemies.forEach(enemy => {
                if (enemy.active) {
                    // –¢–µ–Ω—å
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y + 5, enemy.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –¢–µ–ª–æ
                    ctx.fillStyle = enemy.color;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –û—Å–æ–±—ã–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
                    if (enemy.type === "humanoid") {
                        // –ì–ª–∞–∑—ã
                        ctx.fillStyle = '#f00';
                        ctx.beginPath();
                        ctx.arc(enemy.x - 4, enemy.y - 2, 2, 0, Math.PI * 2);
                        ctx.arc(enemy.x + 4, enemy.y - 2, 2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // –†—É–∫–∏
                        ctx.strokeStyle = enemy.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(enemy.x - 6, enemy.y + 5);
                        ctx.lineTo(enemy.x - 12, enemy.y + 15);
                        ctx.moveTo(enemy.x + 6, enemy.y + 5);
                        ctx.lineTo(enemy.x + 12, enemy.y + 15);
                        ctx.stroke();
                    } else if (enemy.type === "dog") {
                        // –£—à–∏
                        ctx.fillStyle = enemy.color;
                        ctx.beginPath();
                        ctx.moveTo(enemy.x - 6, enemy.y - 8);
                        ctx.lineTo(enemy.x - 10, enemy.y - 15);
                        ctx.lineTo(enemy.x - 2, enemy.y - 10);
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(enemy.x + 6, enemy.y - 8);
                        ctx.lineTo(enemy.x + 10, enemy.y - 15);
                        ctx.lineTo(enemy.x + 2, enemy.y - 10);
                        ctx.fill();
                        
                        // –ü–∞—Å—Ç—å
                        ctx.fillStyle = '#f00';
                        ctx.beginPath();
                        ctx.arc(enemy.x, enemy.y + 3, 4, 0, Math.PI);
                        ctx.fill();
                    } else if (enemy.type === "syringe") {
                        // –®–ø—Ä–∏—Ü
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(enemy.x - 2, enemy.y - 10, 4, 15);
                        
                        // –ò–≥–ª–∞
                        ctx.fillStyle = '#aaa';
                        ctx.fillRect(enemy.x - 1, enemy.y - 15, 2, 5);
                        
                        // –ñ–∏–¥–∫–æ—Å—Ç—å
                        ctx.fillStyle = '#1a4';
                        ctx.fillRect(enemy.x - 2, enemy.y - 8, 4, 5);
                    }
                }
            });
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ì–ª–æ—Ä–∏–∏
            drawPlayer();
            
            // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
            ctx.fillStyle = `rgba(0, 0, 0, ${darknessAlpha})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞ (–ì–ª–æ—Ä–∏–∏)
        function drawPlayer() {
            // –¢–µ–Ω—å
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.arc(player.x, player.y + 5, player.size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // –¢–µ–ª–æ (–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç —Å—Ç—Ä–∞—Ö–∞)
            const baseColor = player.fear < 50 ? '#3a2a5a' : 
                            player.fear < 80 ? '#4a3a6a' : '#5a4a7a';
            
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size/2, 0, Math.PI * 2);
            ctx.fill();
            
            // –£—à–∏
            ctx.fillStyle = baseColor;
            ctx.beginPath();
            ctx.moveTo(player.x - 8, player.y - 10);
            ctx.lineTo(player.x - 12, player.y - 20);
            ctx.lineTo(player.x - 4, player.y - 12);
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(player.x + 8, player.y - 10);
            ctx.lineTo(player.x + 12, player.y - 20);
            ctx.lineTo(player.x + 4, player.y - 12);
            ctx.fill();
            
            // –ì–ª–∞–∑—ã
            const eyeColor = player.fear < 50 ? '#a1c9a7' : 
                            player.fear < 80 ? '#d1a9a9' : '#f99';
            
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            
            // –ó—Ä–∞—á–∫–∏
            const pupilSize = player.fear < 50 ? 3 : 
                            player.fear < 80 ? 2 : 1;
            
            // –õ–µ–≤—ã–π –≥–ª–∞–∑
            ctx.arc(player.x - 5, player.y - 2, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#2a1a4a';
            ctx.beginPath();
            ctx.arc(player.x - 5, player.y - 2, pupilSize, 0, Math.PI * 2);
            ctx.fill();
            
            // –ü—Ä–∞–≤—ã–π –≥–ª–∞–∑
            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(player.x + 5, player.y - 2, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#2a1a4a';
            ctx.beginPath();
            ctx.arc(player.x + 5, player.y - 2, pupilSize, 0, Math.PI * 2);
            ctx.fill();
            
            // –£—Å—ã (–µ—Å–ª–∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –Ω–∞–ø—É–≥–∞–Ω–∞)
            if (player.fear < 70) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                // –õ–µ–≤—ã–µ —É—Å—ã
                ctx.beginPath();
                ctx.moveTo(player.x - 8, player.y + 2);
                ctx.lineTo(player.x - 18, player.y);
                ctx.moveTo(player.x - 8, player.y + 3);
                ctx.lineTo(player.x - 18, player.y + 3);
                ctx.moveTo(player.x - 8, player.y + 4);
                ctx.lineTo(player.x - 18, player.y + 6);
                ctx.stroke();
                
                // –ü—Ä–∞–≤—ã–µ —É—Å—ã
                ctx.beginPath();
                ctx.moveTo(player.x + 8, player.y + 2);
                ctx.lineTo(player.x + 18, player.y);
                ctx.moveTo(player.x + 8, player.y + 3);
                ctx.lineTo(player.x + 18, player.y + 3);
                ctx.moveTo(player.x + 8, player.y + 4);
                ctx.lineTo(player.x + 18, player.y + 6);
                ctx.stroke();
            }
            
            // –•–≤–æ—Å—Ç (–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
            ctx.strokeStyle = baseColor;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(player.x, player.y + 10);
            
            const tailCurve = Math.sin(gameTime * 0.1) * (player.fear < 50 ? 5 : 10);
            ctx.quadraticCurveTo(
                player.x + tailCurve, 
                player.y + 20, 
                player.x + (tailCurve * 0.5), 
                player.y + 30
            );
            ctx.stroke();
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–æ–º (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
        function setupJoystick() {
            const joystickRect = joystick.getBoundingClientRect();
            joystickCenterX = joystickRect.left + joystickRect.width / 2;
            joystickCenterY = joystickRect.top + joystickRect.height / 2;
            
            joystick.addEventListener('touchstart', handleJoystickStart);
            joystick.addEventListener('touchmove', handleJoystickMove);
            joystick.addEventListener('touchend', handleJoystickEnd);
            
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ü–ö
            joystick.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
        }
        
        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
            updateJoystickPosition(e);
        }
        
        function handleJoystickMove(e) {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystickPosition(e);
        }
        
        function handleJoystickEnd(e) {
            if (!joystickActive) return;
            e.preventDefault();
            joystickActive = false;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∂–æ–π—Å—Ç–∏–∫ –≤ —Ü–µ–Ω—Ç—Ä
            joystickKnob.style.transform = 'translate(-50%, -50%)';
            joystickX = 0;
            joystickY = 0;
            joystickAngle = 0;
            joystickDistance = 0;
        }
        
        function updateJoystickPosition(e) {
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            joystickX = clientX - joystickCenterX;
            joystickY = clientY - joystickCenterY;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≥—Ä–∞–Ω–∏—Ü –¥–∂–æ–π—Å—Ç–∏–∫–∞
            joystickDistance = Math.min(Math.sqrt(joystickX * joystickX + joystickY * joystickY), 30);
            joystickAngle = Math.atan2(joystickY, joystickX);
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –µ—Å–ª–∏ –≤—ã—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
            if (joystickDistance > 30) {
                joystickX = Math.cos(joystickAngle) * 30;
                joystickY = Math.sin(joystickAngle) * 30;
                joystickDistance = 30;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ä—É—á–∫–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            joystickKnob.style.transform = `translate(${joystickX}px, ${joystickY}px) translate(-50%, -50%)`;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
        function setupActionButtons() {
            telekinesisBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                useTelekinesis();
            });
            
            telekinesisBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                useTelekinesis();
            });
            
            portalBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                usePortal();
            });
            
            portalBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                usePortal();
            });
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (–¥–ª—è –ü–ö)
        function setupKeyboardControls() {
            window.addEventListener('keydown', (e) => {
                if (e.key in keys) {
                    keys[e.key] = true;
                    e.preventDefault();
                }
                
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
                if (e.key.toLowerCase() === 'r' && !gameRunning) {
                    startGame();
                }
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key in keys) {
                    keys[e.key] = false;
                    e.preventDefault();
                }
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
        function setupSoundToggle() {
            soundToggle.addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                
                if (soundEnabled) {
                    soundToggle.textContent = 'üîä';
                    bgMusic.volume = 0.3;
                    if (gameRunning) bgMusic.play().catch(e => console.log(e));
                } else {
                    soundToggle.textContent = 'üîá';
                    bgMusic.pause();
                }
            });
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function setupControls() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º
            isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                mobileControls.style.display = 'block';
                actionButtons.style.display = 'flex';
                abilityCooldowns.style.display = 'flex';
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∂–æ–π—Å—Ç–∏–∫ –∏ –∫–Ω–æ–ø–∫–∏
                setupJoystick();
                setupActionButtons();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                controlsInfo.textContent = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –î–∂–æ–π—Å—Ç–∏–∫ - –¥–≤–∏–∂–µ–Ω–∏–µ, –∫–Ω–æ–ø–∫–∏ - —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏";
            } else {
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                setupKeyboardControls();
                abilityCooldowns.style.display = 'flex';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
                controlsInfo.textContent = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –°—Ç—Ä–µ–ª–∫–∏ - –¥–≤–∏–∂–µ–Ω–∏–µ, T - —Ç–µ–ª–µ–∫–∏–Ω–µ–∑, P - –ø–æ—Ä—Ç–∞–ª, M - –º–∏–Ω–∏-–∫–∞—Ä—Ç–∞, R - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫";
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
            setupSoundToggle();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ç-—Å—Ü–µ–Ω—É
        function showEndingScene() {
            const endingScreen = document.getElementById('ending-screen');
            endingScreen.style.display = 'flex';
            
            // –ü—Ä—è—á–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            document.getElementById('ui').style.display = 'none';
            document.getElementById('inventory').style.display = 'none';
            document.getElementById('fear-bar').style.display = 'none';
            document.getElementById('telekenesis-bar').style.display = 'none';
            document.getElementById('fear-label').style.display = 'none';
            document.getElementById('telekenesis-label').style.display = 'none';
            document.getElementById('room-indicator').style.display = 'none';
            document.getElementById('mini-map').style.display = 'none';
            
            // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            setTimeout(() => {
                document.getElementById('ending-image').classList.add('show');
            }, 2500);
            
            setTimeout(() => {
                document.getElementById('ending-button').classList.add('show');
            }, 3500);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞"
            document.getElementById('ending-button').addEventListener('click', () => {
                endingScreen.style.display = 'none';
                startGame();
            });
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function startGame() {
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ç-—Å—Ü–µ–Ω—É
            document.getElementById('ending-screen').style.display = 'none';
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ canvas
            resizeCanvas();
            
            player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 20,
                speed: 3,
                health: 100,
                fear: 0,
                maxFear: 100,
                artifacts: 0,
                telekinesis: 0,
                maxTelekinesis: 100,
                telekinesisCooldown: 5000,
                lastTelekinesisUse: 0,
                portalCharges: 3,
                maxPortalCharges: 3,
                portalCooldown: 15000,
                lastPortalUse: 0,
                dogEnemiesNearby: 0,
                visitedRooms: new Set()
            };
            
            artifactCountElement.textContent = '0';
            healthFillElement.style.width = '100%';
            fearFillElement.style.width = '0%';
            telekenesisFillElement.style.width = '0%';
            darknessAlpha = 0.7;
            
            generateRooms();
            gameTime = 0;
            lastEnemySpawn = 0;
            lastFearIncrease = Date.now();
            lastTelekinesisIncrease = Date.now();
            
            startScreen.style.display = 'none';
            gameRunning = true;
            restartBtn.style.display = 'none';
            restartBtn.textContent = "–†–ï–°–¢–ê–†–¢ (R)";
            
            updateInventory();
            
            if (soundEnabled) {
                bgMusic.volume = 0.3;
                bgMusic.play().catch(e => console.log("Audio play failed:", e));
            }
            
            showDialog(story);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
            clearInterval(cooldownInterval);
            cooldownInterval = setInterval(updateCooldownIndicators, 100);
            
            update();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function init() {
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            setupControls();
            
            // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –≤ –¥–∏–∞–ª–æ–≥–µ
            dialogNext.addEventListener('click', nextDialog);
            dialogNext.addEventListener('touchstart', (e) => {
                e.preventDefault();
                nextDialog();
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç–∞
            startButton.addEventListener('click', startGame);
            startButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startGame();
            });
            
            // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
            restartBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startGame();
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', resizeCanvas);
            
            // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
            resizeCanvas();
            draw();
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', init);
    </script>
</body>
</html>
